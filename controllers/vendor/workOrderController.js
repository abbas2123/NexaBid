const postAwardService = require('../../services/vendor/postAward');
const statusCode = require('../../utils/statusCode');
const PDFDocument = require('pdfkit');
const { LAYOUTS, VIEWS, ERROR_MESSAGES } = require('../../utils/constants');

exports.viewWorkOrder = async (req, res) => {
  try {
    const fileUrl = await postAwardService.getWorkOrderFilePath(req.params.fileId);
    return res.redirect(fileUrl);
  } catch (err) {
    console.error('View work order error:', err.message);
    res.status(statusCode.NOT_FOUND).render(VIEWS.ERROR, {
      layout: LAYOUTS.USER_LAYOUT,
      message: ERROR_MESSAGES.WORK_ORDER_NOT_FOUND,
      user: req.user,
    });
  }
};

exports.trackingPage = async (req, res) => {
  const workOrder = await postAwardService.getTrackingData(req.params.workOrderId);

  if (workOrder.redirectToPostAward) return res.redirect('/auth/dashboard');

  if (workOrder.status === 'completed') {
    return res.redirect(`/publisher/work-order/completed/completion-${workOrder._id}`);
  }

  res.render(VIEWS.WORK_ORDER_TRACKING, {
    layout: LAYOUTS.USER_LAYOUT,
    workOrder,
    user: req.user,
  });
};

exports.addNote = async (req, res) => {
  const { workOrderId } = req.params;
  const { content } = req.body;

  if (!content) return res.status(400).json({ success: false, message: 'Note empty' });

  await postAwardService.addNote(workOrderId, req.user._id, content);
  res.json({ success: true });
};

exports.reviewMilestone = async (req, res) => {
  await postAwardService.reviewMilestone(
    req.params.id,
    req.params.mid,
    req.body.action,
    req.body.comment
  );
  res.json({ success: true });
};

exports.approveProof = async (req, res) => {
  await postAwardService.approveProof(req.params.workOrderId, req.params.pid);
  res.json({ success: true });
};

exports.rejectProof = async (req, res) => {
  await postAwardService.rejectProof(req.params.workOrderId, req.params.pid, req.body.reason);
  res.json({ success: true });
};

exports.completeWorkOrder = async (req, res) => {
  const result = await postAwardService.completeWorkOrder(req.params.workOrderId);
  res.json({ success: true, workOrder: result.wo });
};

exports.workOrderCompletionPage = async (req, res) => {
  console.log('[DEBUG] workOrderCompletionPage hit. Params:', req.params);
  try {
    const data = await postAwardService.getCompletionSummary(req.params.id);
    console.log('[DEBUG] getCompletionSummary success. Data keys:', Object.keys(data));

    res.render(VIEWS.WORK_ORDER_COMPLETED, {
      layout: LAYOUTS.USER_LAYOUT,
      ...data,
      user: req.user,
    });
  } catch (err) {
    console.error('[DEBUG] workOrderCompletionPage error:', err);
    res.redirect('/auth/dashboard');
  }
};

exports.downloadReport = async (req, res) => {
  try {
    const { workOrderId } = req.params;
    const data = await postAwardService.getCompletionSummary(workOrderId);
    const { workOrder } = data;

    const doc = new PDFDocument({ margin: 50 });

    res.setHeader('Content-Type', 'application/pdf');
    res.setHeader(
      'Content-Disposition',
      `attachment; filename=Completion-Report-${workOrder.woNumber}.pdf`
    );

    doc.pipe(res);

    // Header
    doc.fontSize(20).text('NexaBid', { align: 'center' });
    doc.moveDown();
    doc.fontSize(24).font('Helvetica-Bold').text('Work Order Completion Report', { align: 'center' });
    doc.moveDown();

    // Work Order Info
    doc.fontSize(12).font('Helvetica').text(`WO Number: ${workOrder.woNumber}`);
    doc.text(`Title: ${workOrder.tenderId.title}`);
    doc.text(`Vendor: ${workOrder.vendorName}`);
    doc.text(`Completion Date: ${new Date(workOrder.completedAt).toLocaleDateString()}`);
    doc.moveDown();

    // Separator
    doc.moveTo(50, doc.y).lineTo(550, doc.y).stroke();
    doc.moveDown();

    // Summary
    doc.font('Helvetica-Bold').text('Progress Summary');
    doc.font('Helvetica').text('All milestones have been marked as completed.');
    doc.text(`Payment Status: Invoice Generated`);
    doc.moveDown();

    // Milestones
    doc.font('Helvetica-Bold').text('Milestones Executed:');
    doc.moveDown(0.5);

    workOrder.milestones.forEach((m, i) => {
      doc.font('Helvetica-Bold').text(`${i + 1}. ${m.description || m.name}`);
      doc.font('Helvetica').text(`   Status: ${m.status}`);
      doc.text(`   Completed At: ${new Date(m.completedAt || m.updatedAt || Date.now()).toLocaleDateString()}`);
      doc.moveDown(0.5);
    });

    // Footer
    doc.moveDown(2);
    doc.fontSize(10).text('Generated by NexaBid System', { align: 'center', color: 'gray' });

    doc.end();
  } catch (err) {
    console.error('Download report error:', err);
    res.status(500).send('Failed to generate report');
  }
};
