<div class="p-4 w-full">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
    <div>
      <h1 class="text-3xl font-bold">Coupon Management</h1>
      <p class="text-gray-500 text-sm">Manage and create discount coupons</p>
    </div>

    <button
      id="openCouponBtn"
      type="button"
      class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700"
    >
      Create Coupon
    </button>
  </div>

  <div class="bg-white rounded-xl border shadow overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50 border-b">
        <tr>
          <th class="px-4 py-3 text-left">Code</th>
          <th class="px-4 py-3 text-left">Type</th>
          <th class="px-4 py-3 text-left">Value</th>
          <th class="px-4 py-3 text-left">Expiry</th>
          <th class="px-4 py-3 text-center">User Limit</th>
          <th class="px-4 py-3 text-center">Total Limit</th>
          <th class="px-4 py-3 text-left">Status</th>
          <th class="px-4 py-3 text-right">Actions</th>
        </tr>
      </thead>

      <tbody class="divide-y">
        <% if (coupons && coupons.length > 0) { %> <% coupons.forEach(c => { %>
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 font-semibold"><%= c.code %></td>
          <td class="px-4 py-3 capitalize"><%= c.type %></td>
          <td class="px-4 py-3"><%= c.type === 'percent' ? c.value + '%' : '₹' + c.value %></td>
          <td class="px-4 py-3">
            <%= c.expiresAt ? new Date(c.expiresAt).toLocaleDateString() : '—' %>
          </td>
          <td class="px-4 py-3 text-center"><%= c.perUserLimit || '∞' %></td>
          <td class="px-4 py-3 text-center"><%= c.usageLimit || '∞' %></td>

          <!-- ✅ REAL status based on isActive -->
          <td class="px-4 py-3">
            <% const isExpired = c.expiresAt && new Date(c.expiresAt) < new Date(); %> <% if
            (isExpired) { %>
            <span class="text-red-600 font-semibold">Expired</span>
            <% } else if (c.isActive) { %>
            <span class="text-green-600 font-semibold">Enabled</span>
            <% } else { %>
            <span class="text-gray-500 font-semibold">Disabled</span>
            <% } %>
          </td>

          <td class="px-4 py-3 text-right space-x-3">
            <button type="button" class="text-amber-600 js-toggle" data-id="<%= c._id %>">
              Toggle
            </button>
            <button type="button" class="text-red-600 js-delete" data-id="<%= c._id %>">
              Delete
            </button>
          </td>
        </tr>
        <% }) %> <% } else { %>
        <tr>
          <td colspan="8" class="text-center py-6 text-gray-500">No coupons available</td>
        </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- MODAL -->
<div id="couponModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center border-b px-6 py-4">
      <h2 class="text-xl font-bold">Create New Coupon</h2>
      <button id="closeCouponBtn" type="button" class="text-gray-500 hover:text-black">✕</button>
    </div>

    <form id="createCouponForm" class="p-6 space-y-6">
      <div>
        <label class="block text-sm font-medium mb-1">Coupon Code</label>
        <input
          name="code"
          required
          class="w-full border rounded px-4 py-2 uppercase"
          placeholder="SUMMER2025"
        />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Discount Type</label>
          <select name="type" class="w-full border rounded px-4 py-2">
            <option value="percent">Percentage (%)</option>
            <option value="flat">Flat Amount (₹)</option>
            <option value="cashback">Cashback</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Discount Value</label>
          <input name="value" type="number" required class="w-full border rounded px-4 py-2" />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Min Purchase Amount</label>
          <input name="minPurchaseAmount" type="number" class="w-full border rounded px-4 py-2" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Max Discount</label>
          <input name="maxDiscount" type="number" class="w-full border rounded px-4 py-2" />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Per User Limit</label>
          <input name="perUserLimit" type="number" class="w-full border rounded px-4 py-2" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Total Usage Limit</label>
          <input name="usageLimit" type="number" class="w-full border rounded px-4 py-2" />
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Expiry Date</label>
        <input name="expiresAt" type="date" class="w-full border rounded px-4 py-2" />
      </div>

      <div class="flex justify-end gap-3 pt-4 border-t">
        <button type="button" id="cancelCouponBtn" class="px-6 py-2 rounded bg-gray-200">
          Cancel
        </button>
        <button
          type="submit"
          class="px-6 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white font-semibold"
        >
          Create Coupon
        </button>
      </div>
    </form>
  </div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('couponModal');
    const openBtn = document.getElementById('openCouponBtn');
    const closeBtn = document.getElementById('closeCouponBtn');
    const cancelBtn = document.getElementById('cancelCouponBtn');
    const form = document.getElementById('createCouponForm');

    const openModal = () => {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    };
    const closeModal = () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    };

    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    // CREATE
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());

      try {
        const res = await fetch('/admin/coupon-management/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await res.json();

        if (!data.success) {
          return Swal.fire({ icon: 'error', title: 'Failed', text: data.message || 'Error' });
        }

        await Swal.fire({
          icon: 'success',
          title: 'Coupon Created',
          text: data.message || 'Created successfully',
          timer: 1400,
          showConfirmButton: false,
        });

        window.location.reload();
      } catch (err) {
        console.error(err);
        Swal.fire({ icon: 'error', title: 'Server error', text: 'Please try again' });
      } finally {
        closeModal();
      }
    });

    // DELETE
    document.querySelectorAll('.js-delete').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;

        const confirm = await Swal.fire({
          icon: 'warning',
          title: 'Delete coupon?',
          showCancelButton: true,
          confirmButtonText: 'Delete',
          cancelButtonText: 'Cancel',
        });

        if (!confirm.isConfirmed) return;

        const res = await fetch(`/admin/coupon-management/${id}`, { method: 'DELETE' });
        const data = await res.json();

        if (!data.success) {
          return Swal.fire({
            icon: 'error',
            title: 'Failed',
            text: data.message || 'Delete failed',
          });
        }

        await Swal.fire({
          icon: 'success',
          title: 'Deleted',
          timer: 1000,
          showConfirmButton: false,
        });
        window.location.reload();
      });
    });

    // TOGGLE
    document.querySelectorAll('.js-toggle').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;

        const res = await fetch(`/admin/coupon-management/toggle/${id}`, { method: 'PATCH' });
        const data = await res.json();

        if (!data.success) {
          return Swal.fire({
            icon: 'error',
            title: 'Failed',
            text: data.message || 'Toggle failed',
          });
        }

        await Swal.fire({
          icon: 'success',
          title: 'Updated',
          text: data.isActive ? 'Enabled' : 'Disabled',
          timer: 1000,
          showConfirmButton: false,
        });

        window.location.reload();
      });
    });
  });
</script>
