<body class="bg-gray-50 min-h-screen">
  <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-10">
    <!-- Breadcrumbs -->
    <div class="flex flex-wrap gap-2 text-sm mb-6">
      <a class="text-gray-600 dark:text-gray-400 hover:text-blue-600 transition-colors"
        href="/auth/dashboard">Dashboard</a>
      <span class="text-gray-400">/</span>
      <a class="text-gray-600 dark:text-gray-400 hover:text-blue-600 transition-colors" href="/wallet">My Wallet</a>
      <span class="text-gray-400">/</span>
      <span class="text-gray-900 dark:text-white font-medium">Add Funds</span>
    </div>

    <!-- Back Button -->
    <div class="mb-6">
      <button onclick="window.location.href = '/wallet'"
        class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
        <span class="material-icons">arrow_back</span>
        <span class="font-medium">Back to Wallet</span>
      </button>
    </div>

    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Add Funds</h1>
      <p class="text-gray-600">
        Add money to your NexaBid wallet to participate in auctions and tenders
      </p>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Main Form -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Current Balance Card -->
        <div class="bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl p-6 shadow-lg">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center backdrop-blur-sm">
              <span class="material-icons text-white">account_balance_wallet</span>
            </div>
            <p class="text-white/90 font-medium">Current Balance</p>
          </div>
          <p class="text-4xl font-bold text-white">
            ‚Çπ<%= (walletBalance || 0).toLocaleString('en-IN') %>
          </p>
        </div>

        <!-- Amount Selection -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-6">Select Amount</h2>

          <!-- Quick Amount Buttons -->
          <div class="grid grid-cols-3 gap-3 mb-6">
            <button onclick="selectAmount(5000)"
              class="quick-amount-btn px-6 py-4 bg-gray-50 border-2 border-gray-200 rounded-xl hover:border-indigo-600 hover:bg-indigo-50 transition-all text-center group">
              <p class="text-2xl font-bold text-gray-900 group-hover:text-indigo-600">‚Çπ5,000</p>
              <p class="text-xs text-gray-500 mt-1">Starter</p>
            </button>
            <button onclick="selectAmount(10000)"
              class="quick-amount-btn px-6 py-4 bg-gray-50 border-2 border-gray-200 rounded-xl hover:border-indigo-600 hover:bg-indigo-50 transition-all text-center group">
              <p class="text-2xl font-bold text-gray-900 group-hover:text-indigo-600">‚Çπ10,000</p>
              <p class="text-xs text-gray-500 mt-1">Popular</p>
            </button>
            <button onclick="selectAmount(25000)"
              class="quick-amount-btn px-6 py-4 bg-gray-50 border-2 border-gray-200 rounded-xl hover:border-indigo-600 hover:bg-indigo-50 transition-all text-center group">
              <p class="text-2xl font-bold text-gray-900 group-hover:text-indigo-600">‚Çπ25,000</p>
              <p class="text-xs text-gray-500 mt-1">Pro</p>
            </button>
          </div>

          <!-- Custom Amount Input -->
          <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-3">Or Enter Custom Amount</label>
            <div class="relative">
              <span class="absolute left-4 top-1/2 -translate-y-1/2 text-2xl font-bold text-gray-500">‚Çπ</span>
              <input type="number" id="customAmount" min="100" step="100" placeholder="Enter amount"
                class="w-full pl-12 pr-4 py-4 text-2xl font-bold border-2 border-gray-200 rounded-xl focus:border-indigo-600 focus:ring-0 transition-colors"
                oninput="updateAmount(this.value)" />
            </div>
            <p class="text-sm text-gray-500 mt-2">Minimum amount: ‚Çπ100</p>
          </div>

          <!-- Payment Summary -->
          <div class="bg-gray-50 rounded-xl p-5 mb-6">
            <div class="flex justify-between items-center mb-3">
              <span class="text-gray-700">Amount to Add</span>
              <span class="text-xl font-bold text-gray-900" id="displayAmount">‚Çπ0</span>
            </div>
            <div class="flex justify-between items-center mb-3">
              <span class="text-gray-700">Processing Fee</span>
              <span class="text-gray-900 font-semibold">‚Çπ0</span>
            </div>
            <div class="h-px bg-gray-300 my-3"></div>
            <div class="flex justify-between items-center">
              <span class="text-lg font-bold text-gray-900">Total Amount</span>
              <span class="text-2xl font-bold text-indigo-600" id="totalAmount">‚Çπ0</span>
            </div>
          </div>

          <!-- Payment Method -->
          <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-3">Payment Method</label>
            <div class="space-y-3">
              <label
                class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-indigo-600 hover:bg-indigo-50 transition-all">
                <input type="radio" name="paymentMethod" value="razorpay" checked class="w-5 h-5 text-indigo-600" />
                <div class="ml-4 flex-1">
                  <div class="flex items-center justify-between">
                    <span class="font-semibold text-gray-900">Razorpay</span>
                    <img src="https://razorpay.com/assets/razorpay-glyph.svg" alt="Razorpay" class="h-6" />
                  </div>
                  <p class="text-sm text-gray-500 mt-1">UPI, Cards, NetBanking, Wallets</p>
                </div>
              </label>
            </div>
          </div>

          <!-- Action Button -->
          <button id="proceedBtn" onclick="initiatePayment()" disabled
            class="w-full px-6 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            <span class="material-icons">lock</span>
            <span>Proceed to Secure Payment</span>
          </button>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Security Info -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
              <span class="material-icons text-green-600 text-2xl">verified_user</span>
            </div>
            <h3 class="font-bold text-gray-900">100% Secure</h3>
          </div>
          <ul class="space-y-3 text-sm text-gray-600">
            <li class="flex items-start gap-2">
              <span class="material-icons text-green-600 text-lg mt-0.5">check_circle</span>
              <span>256-bit SSL encryption</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="material-icons text-green-600 text-lg mt-0.5">check_circle</span>
              <span>PCI DSS compliant</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="material-icons text-green-600 text-lg mt-0.5">check_circle</span>
              <span>Secure payment gateway</span>
            </li>
          </ul>
        </div>

        <!-- Why Add Funds -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
          <h3 class="font-bold text-gray-900 mb-4">Why Add Funds?</h3>
          <ul class="space-y-3 text-sm text-gray-600">
            <li class="flex items-start gap-2">
              <span class="material-icons text-indigo-600 text-lg mt-0.5">bolt</span>
              <span>Instant participation in auctions</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="material-icons text-indigo-600 text-lg mt-0.5">payments</span>
              <span>Quick tender deposits</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="material-icons text-indigo-600 text-lg mt-0.5">history</span>
              <span>60% refund on losing bids</span>
            </li>
          </ul>
        </div>

        <!-- Help -->
        <div class="bg-indigo-50 rounded-2xl border border-indigo-200 p-6">
          <div class="flex items-center gap-3 mb-3">
            <span class="material-icons text-indigo-600 text-2xl">help</span>
            <h3 class="font-bold text-gray-900">Need Help?</h3>
          </div>
          <p class="text-sm text-gray-600 mb-4">Our support team is available 24/7 to assist you</p>
          <button
            class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">
            Contact Support
          </button>
        </div>
      </div>
    </div>
  </main>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    let selectedAmount = 0;

    function selectAmount(amount) {
      selectedAmount = amount;
      document.getElementById('customAmount').value = amount;
      updateAmount(amount);

      // Update button styles
      document.querySelectorAll('.quick-amount-btn').forEach((btn) => {
        btn.classList.remove('border-indigo-600', 'bg-indigo-50');
        btn.classList.add('border-gray-200', 'bg-gray-50');
      });
      event.target.closest('button').classList.add('border-indigo-600', 'bg-indigo-50');
    }

    function updateAmount(amount) {
      selectedAmount = parseFloat(amount) || 0;
      document.getElementById('displayAmount').textContent =
        '‚Çπ' + selectedAmount.toLocaleString('en-IN');
      document.getElementById('totalAmount').textContent =
        '‚Çπ' + selectedAmount.toLocaleString('en-IN');

      // Enable/disable button
      const proceedBtn = document.getElementById('proceedBtn');
      if (selectedAmount >= 100) {
        proceedBtn.disabled = false;
      } else {
        proceedBtn.disabled = true;
      }
    }

    async function initiatePayment() {
      if (selectedAmount < 100) {
        Swal.fire({ icon: 'warning', title: 'Invalid Amount', text: 'Minimum amount is ‚Çπ100' });
        return;
      }

      const proceedBtn = document.getElementById('proceedBtn');
      const originalBtnHTML = proceedBtn.innerHTML;

      // Show loading
      proceedBtn.disabled = true;
      proceedBtn.innerHTML =
        '<span class="material-icons animate-spin">refresh</span><span>Processing...</span>';

      try {
        console.log('üí≥ Creating order for amount:', selectedAmount);

        // Create order on server
        const response = await fetch('/wallet/api/create-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ amount: selectedAmount }),
        });

        console.log('üì• Response status:', response.status);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('üì• Response ', data);

        if (!data.success) {
          console.error('‚ùå Order creation failed:', data.message);
          alert('Failed to create order:\n' + (data.message || 'Unknown error'));
          proceedBtn.disabled = false;
          proceedBtn.innerHTML = originalBtnHTML;
          return;
        }

        console.log('‚úÖ Order created successfully:', data.orderId);

        // Check if Razorpay loaded
        if (typeof Razorpay === 'undefined') {
          alert('Payment gateway not loaded. Please refresh the page.');
          proceedBtn.disabled = false;
          proceedBtn.innerHTML = originalBtnHTML;
          return;
        }

        // Initialize Razorpay
        const options = {
          key: '<%= process.env.RAZORPAY_KEY_ID %>',
          amount: data.amount,
          currency: 'INR',
          name: 'NexaBid',
          description: 'Add Funds to Wallet',
          order_id: data.orderId,
          // CRITICAL: Callback URL for Netbanking redirects
          callback_url: window.location.origin + '/wallet/api/verify-payment?userId=<%= user._id %>',
          redirect: true,

          handler: function (response) {
            // For UPI/Cards that don't auto-redirect, we manually submit the form
            // to the SAME callback URL.

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/wallet/api/verify-payment?userId=<%= user._id %>';
            form.style.display = 'none';

            const addField = (name, value) => {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = name;
              input.value = value;
              form.appendChild(input);
            };

            addField('razorpay_payment_id', response.razorpay_payment_id);
            addField('razorpay_order_id', response.razorpay_order_id);
            addField('razorpay_signature', response.razorpay_signature);
            // We MUST pass amount because backend controller expects it & Razorpay callback doesn't send it by default
            addField('amount', selectedAmount);

            document.body.appendChild(form);
            form.submit();
          },
          modal: {
            ondismiss: function () {
              console.log('‚ö†Ô∏è Payment cancelled');
              proceedBtn.disabled = false;
              proceedBtn.innerHTML = originalBtnHTML;
            },
          },
          prefill: {
            name: '<%= user.name %>',
            email: '<%= user.email %>',
          },
          theme: {
            color: '#4F46E5',
          },
        };

        console.log('üöÄ Opening Razorpay checkout...');
        const rzp = new Razorpay(options);

        rzp.on('payment.failed', function (response) {
          console.error('‚ùå Payment failed:', response.error);
          alert('Payment failed:\n' + response.error.description);
          proceedBtn.disabled = false;
          proceedBtn.innerHTML = originalBtnHTML;
        });

        rzp.open();
      } catch (error) {
        console.error('‚ùå Payment initiation error:', error);
        alert('Error initiating payment:\n' + error.message);
        proceedBtn.disabled = false;
        proceedBtn.innerHTML = originalBtnHTML;
      }
    }

    // Add CSS for spinning animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    `;
    document.head.appendChild(style);
  </script>
</body>