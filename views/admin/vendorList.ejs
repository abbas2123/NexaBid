<div>
  <h1 class="text-2xl font-bold mb-6">Vendor Applications</h1>

  <!-- FILTERS -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">

    <!-- Search -->
    <input id="searchInput" type="text" placeholder="Search by business name, owner, email..."
      value="<%= applied.search || '' %>" class="w-full md:w-1/2 border rounded px-3 py-2" />

    <!-- Status Filter -->
    <select id="statusFilter" class="w-full md:w-48 border px-3 py-2 rounded">
      <option value="">All Status</option>
      <option value="submitted" <%=applied.status==='submitted' ? 'selected' : '' %>>Submitted</option>
      <option value="pending" <%=applied.status==='pending' ? 'selected' : '' %>>Pending</option>
      <option value="approved" <%=applied.status==='approved' ? 'selected' : '' %>>Approved</option>
      <option value="rejected" <%=applied.status==='rejected' ? 'selected' : '' %>>Rejected</option>
    </select>

  </div>

  <!-- Active Filters Display -->
  <% if (applied.search || applied.status) { %>
    <div class="flex items-center gap-2 mb-4 flex-wrap">
      <span class="text-sm text-gray-600">Active filters:</span>

      <% if (applied.search) { %>
        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs flex items-center gap-2">
          Search: "<%= applied.search %>"
            <a href="?page=1&status=<%= applied.status || '' %>" class="hover:text-blue-900 font-bold">Ã—</a>
        </span>
        <% } %>

          <% if (applied.status) { %>
            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs flex items-center gap-2">
              Status: <%= applied.status %>
                <a href="?page=1&search=<%= applied.search || '' %>" class="hover:text-green-900 font-bold">Ã—</a>
            </span>
            <% } %>

              <a href="?page=1" class="text-xs text-red-600 hover:underline ml-2">Clear all filters</a>
    </div>
    <% } %>

      <!-- Results Summary -->
      <div class="mb-4 text-sm text-gray-600">
        Showing <%= vendorApps.length %> vendor applications
          <% if (applied.search || applied.status) { %>
            (filtered)
            <% } %>
      </div>

      <!-- TABLE -->
      <div class="bg-white rounded-lg border p-4 overflow-x-auto">
        <table class="w-full text-left text-sm">
          <thead>
            <tr class="text-gray-600 border-b">
              <th class="py-3">Business Name</th>
              <th class="py-3">Owner</th>
              <th class="py-3">Email</th>
              <th class="py-3">Status</th>
              <th class="py-3">Action</th>
            </tr>
          </thead>

          <tbody>
            <% if (!vendorApps || vendorApps.length===0) { %>
              <tr>
                <td colspan="5" class="py-8 text-center text-gray-500">
                  No vendor applications found
                  <% if (applied.search || applied.status) { %>
                    matching your filters
                    <% } %>
                </td>
              </tr>
              <% } else { %>
                <% vendorApps.forEach(v=> { %>
                  <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 font-semibold">
                      <%= v.businessName %>
                    </td>
                    <td class="py-3">
                      <%= v.userId?.name || 'N/A' %>
                    </td>
                    <td class="py-3">
                      <%= v.userId?.email || 'N/A' %>
                    </td>
                    <td class="py-3">
                      <span id="status-<%= v._id %>" class="px-3 py-1 rounded-full text-xs
                  <%= v.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : '' %>
                  <%= v.status === 'submitted' ? 'bg-blue-100 text-blue-700' : '' %>
                  <%= v.status === 'approved' ? 'bg-green-100 text-green-700' : '' %>
                  <%= v.status === 'rejected' ? 'bg-red-100 text-red-700' : '' %>">
                        <%= v.status %>
                      </span>
                    </td>
                    <td class="py-3">

                      <% if (v.status==="approved" ) { %>
                        <!-- REMOVE AS VENDOR BUTTON -->
                        <button class="remove-vendor-btn text-red-600 font-semibold text-xs hover:underline"
                          data-id="<%= v._id %>">
                          Remove Vendor
                        </button>

                        <% } else { %>
                          <!-- REVIEW BUTTON (for pending/submitted) -->
                          <button class="review-btn text-blue-600 font-semibold text-xs hover:underline"
                            data-id="<%= v._id %>">
                            Review
                          </button>

                          <% } %>

                    </td>
                  </tr>
                  <% }) %>
                    <% } %>
          </tbody>
        </table>
      </div>

      <!-- PAGINATION -->
      <%- include('../partials/admin/pagination') %>

</div>



<!-- REVIEW MODAL -->
<div id="reviewModal" class="fixed inset-0 bg-black bg-opacity-40 hidden justify-center items-center z-50 px-4">

  <div class="bg-white w-full max-w-2xl rounded-lg shadow-lg relative max-h-[90vh] overflow-y-auto">

    <!-- Header -->
    <div class="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-50">
      <h2 class="text-xl font-bold">Vendor Application Review</h2>
      <button id="closeReviewModal" class="text-gray-700 text-xl font-bold hover:text-black">Ã—</button>
    </div>

    <!-- Content -->
    <div class="p-4">
      <div id="reviewContent" class="space-y-3 text-gray-700 text-sm"></div>

      <div class="mt-4">
        <label class="font-semibold text-sm">Admin Comments</label>
        <textarea id="adminComment" class="w-full border rounded px-3 py-2 mt-2 text-sm"
          placeholder="Write comments here..." rows="3"></textarea>
      </div>
    </div>

    <!-- Footer -->
    <div class="flex justify-end gap-3 p-4 border-t sticky bottom-0 bg-white z-50">
      <button id="rejectBtn" class="px-4 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700">
        Reject
      </button>
      <button id="approveBtn" class="px-4 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700">
        Approve
      </button>
    </div>

  </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // ----------------- FILTERING ------------------ 
  const searchInput = document.getElementById('searchInput');
  const statusFilter = document.getElementById('statusFilter');

  function applyFilter() {
    const search = searchInput.value.trim();
    const status = statusFilter.value;

    // Build query string
    const params = new URLSearchParams();
    params.set('page', '1'); // Reset to page 1 on filter change
    if (search) params.set('search', search);
    if (status) params.set('status', status);

    // Redirect with filter params
    window.location.href = '?' + params.toString();
  }

  // Debounce function to avoid too many requests while typing
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Add event listeners
  searchInput.addEventListener('input', debounce(applyFilter, 500)); // Wait 500ms after typing stops
  statusFilter.addEventListener('change', applyFilter); // Immediate on dropdown change


  // ----------------- MODAL & REVIEW ------------------
  let currentVendorId = null;

  const modal = document.getElementById("reviewModal");
  const closeModal = document.getElementById("closeReviewModal");
  const content = document.getElementById("reviewContent");
  const commentBox = document.getElementById("adminComment");


  // SAFE JSON FETCH
  async function safeFetch(url, options = {}) {
    const res = await fetch(url, {
      credentials: "include",
      ...options
    });

    const text = await res.text();
    try {
      return { ok: res.ok, status: res.status, json: JSON.parse(text) };
    } catch {
      return { ok: res.ok, status: res.status, json: text };
    }
  }


  // -------------------- OPEN REVIEW MODAL --------------------
  document.querySelectorAll(".review-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      currentVendorId = id;

      // Update status submitted â†’ pending
      await safeFetch(`/admin/vendor/start-review/${id}`, { method: "PATCH" });

      const statusBadge = document.getElementById(`status-${id}`);
      statusBadge.textContent = "pending";
      statusBadge.className = "px-3 py-1 rounded-full text-xs bg-yellow-100 text-yellow-700";

      // Change Review button to normal (no reload needed)

      // Load vendor details
      const details = await safeFetch(`/admin/vendor/details/${id}`);

      if (!details.ok || !details.json.vendor) {
        Swal.fire("Error", "Failed to load vendor details.", "error");
        return;
      }

      const v = details.json.vendor;

      // Build document list
      let docsHTML = "";
      if (v.documents?.length) {
        docsHTML = `
      <p class="font-semibold mt-3">Documents:</p>
      <div class="grid grid-cols-2 gap-3 mt-2">
        ${v.documents.map(doc => {
          const url = doc.fileId.fileUrl;
          const isImage = doc.fileId.mimeType?.startsWith("image/");

          return `
            <a href="${url}" target="_blank"
               class="block border rounded-lg overflow-hidden hover:shadow">
               ${isImage
              ? `<img src="${url}" class="w-full h-32 object-cover">`
              : `<div class="p-4 text-center bg-gray-50">ðŸ“„ View Document</div>`}
            </a>
          `;
        }).join("")}
      </div>`;
      }

      // Fill modal
      content.innerHTML = `
      <p><b>Business Name:</b> ${v.businessName}</p>
      <p><b>PAN:</b> ${v.panNumber || 'N/A'}</p>
      <p><b>GST:</b> ${v.gstNumber || 'N/A'}</p>
      <p><b>Owner:</b> ${v.userId?.name || 'N/A'}</p>
      <p><b>Email:</b> ${v.userId?.email || 'N/A'}</p>
      <p><b>Phone:</b> ${v.userId?.phone || 'N/A'}</p>
      ${docsHTML}
    `;

      modal.classList.remove("hidden");
      modal.classList.add("flex");
    });
  });


  // -------------------- CLOSE MODAL --------------------
  closeModal.addEventListener("click", () => {
    modal.classList.add("hidden");
    modal.classList.remove("flex");

  });


  // -------------------- APPROVE --------------------
  document.getElementById("approveBtn").addEventListener("click", async () => {
    const res = await safeFetch(`/admin/vendor/approve/${currentVendorId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ comment: commentBox.value })
    });


    if (!res.ok || res.json.success === false) {
      return Swal.fire("Approval Failed", res.json.message || "Unknown error", "error");
    }

    Swal.fire("Approved!", "The vendor has been approved.", "success")
      .then(() => location.reload());
  });


  // -------------------- REJECT --------------------
  document.getElementById("rejectBtn").addEventListener("click", async () => {
    const comment = commentBox.value.trim();

    if (!comment) {
      return Swal.fire("Comment Required", "Please provide a reason for rejection", "warning");
    }

    const res = await safeFetch(`/admin/vendor/reject/${currentVendorId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ comment })
    });


    if (!res.ok || res.json.success === false) {
      return Swal.fire("Rejection Failed", res.json.message || "Unknown error", "error");
    }

    Swal.fire("Rejected", "The vendor has been rejected.", "info")
      .then(() => location.reload());
  });


  // -------------------- REMOVE VENDOR --------------------
  document.querySelectorAll(".remove-vendor-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;

      const result = await Swal.fire({
        title: "Remove Vendor?",
        text: "This will remove vendor access and revert the user back to a normal user.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Yes, Remove",
        cancelButtonText: "Cancel"
      });

      if (!result.isConfirmed) return;

      const res = await fetch(`/admin/vendor/remove/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" }
      });

      const data = await res.json();

      if (data.success) {
        Swal.fire({
          text: "Vendor rights removed!",
          title: 'Removed',
          icon: "success",
          showCancelButton: false
        }).then(() => location.reload());
      } else {
        Swal.fire("Failed", data.message || "Failed to remove vendor", "error");
      }
    });
  });
</script>