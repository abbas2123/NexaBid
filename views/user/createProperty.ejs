<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-0 py-6 sm:py-8">

  <!-- Page Title -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900 dark:text-white">
      <%= property ? "Update Property" : "List a New Property" %>
    </h1>

    <a href="/properties" class="text-sm px-3 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">
      Back
    </a>
  </div>


  <!------------------------------ FORM ----------------------------->
  <form id="propertyForm" data-id="<%= property?._id || '' %>" enctype="multipart/form-data" class="space-y-8">

    <!---------------- PROPERTY DETAILS ---------------->
    <section class="bg-white p-6 shadow-sm rounded-lg border">
      <h2 class="text-lg font-bold mb-4">Property Details</h2>

      <div class="space-y-4">
        <div>
          <label>Title *</label>
          <input name="title" id="title" value="<%= property?.title || '' %>" class="w-full border rounded p-2" />
        </div>

        <div>
          <label>Description *</label>
          <textarea name="description" id="description" rows="4"
            class="w-full border rounded p-2"><%= property?.description || '' %></textarea>
        </div>

        <div>
          <label>Type *</label>
          <select name="type" id="type" class="w-full border rounded p-2">
            <option value="">Select</option>
            <option value="house" <%=property?.type==="house" ? "selected" : "" %>>House</option>
            <option value="apartment" <%=property?.type==="apartment" ? "selected" : "" %>>Apartment</option>
            <option value="land" <%=property?.type==="land" ? "selected" : "" %>>Land</option>
            <option value="commercial" <%=property?.type==="commercial" ? "selected" : "" %>>Commercial</option>
          </select>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <input placeholder="BHK" name="bhk" id="bhk" value="<%= property?.bhk || '' %>" class="border rounded p-2" />
          <input placeholder="Size in sqft" name="size" id="size" value="<%= property?.size || '' %>"
            class="border rounded p-2" />
        </div>

      </div>
    </section>


    <!------------------------- LOCATION ------------------------------>
    <section class="bg-white p-6 shadow-sm rounded-lg border space-y-4">
      <h2 class="text-lg font-bold mb-4">Location</h2>

      <input name="address" id="address" value="<%= property?.address || '' %>" placeholder="Enter address"
        class="w-full border rounded p-2" />

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <input placeholder="State" name="locationState" id="locationState" value="<%= property?.locationState || '' %>"
          class="border rounded p-2" />

        <input placeholder="District" name="locationDistrict" id="locationDistrict"
          value="<%= property?.locationDistrict || '' %>" class="border rounded p-2" />
      </div>

      <p class="text-sm font-semibold mt-2">
        Click on the map to select location
      </p>

      <div id="map" class="w-full h-64 rounded bg-gray-300"></div>

      <div class="grid grid-cols-2 gap-4 mt-2">
        <input readonly name="geoLat" id="geoLat" value="<%= property?.geoLat || '' %>" class="border rounded p-2" />
        <input readonly name="geoLng" id="geoLng" value="<%= property?.geoLng || '' %>" class="border rounded p-2" />
      </div>
    </section>


    <!------------------------ PRICING ------------------------------>
    <section class="bg-white p-6 shadow-sm rounded-lg border space-y-6">

      <div class="flex justify-between items-center border-b pb-4 mb-4">
        <h2 class="text-lg font-bold">Pricing & Auction</h2>

        <label class="flex items-center gap-3 cursor-pointer">
          <span class="font-medium text-gray-700">Enable Auction</span>
          <input name="isAuction" id="isAuction" type="checkbox" class="w-5 h-5 text-blue-600 rounded"
            <%=property?.isAuction ? "checked" : "" %> />
        </label>
      </div>

      <!-- AUCTION FIELDS (Unified Grid) -->
      <div class="auctionFields grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Row 1 -->
        <div>
          <label class="font-medium block mb-2 text-gray-700">Base Price <span class="text-red-500">*</span></label>
          <div class="relative">
            <span class="absolute left-3 top-2 text-gray-500">â‚¹</span>
            <input type="number" id="basePrice" name="basePrice" value="<%= property?.basePrice || '' %>"
              class="pl-8 w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              placeholder="0.00">
          </div>
        </div>

        <div>
          <label class="font-medium block mb-2 text-gray-700">Auction Step <span class="text-red-500">*</span></label>
          <div class="relative">
            <span class="absolute left-3 top-2 text-gray-500">â‚¹</span>
            <input type="number" id="auctionStep" name="auctionStep" value="<%= property?.auctionStep || '' %>"
              class="pl-8 w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              placeholder="Increment amount">
          </div>
        </div>

        <!-- Row 2 -->
        <div>
          <label class="font-medium block mb-2 text-gray-700">Reserve Price <span class="text-red-500">*</span></label>
          <div class="relative">
            <span class="absolute left-3 top-2 text-gray-500">â‚¹</span>
            <input type="number" id="auctionReservePrice" name="auctionReservePrice"
              value="<%= property?.auctionReservePrice || '' %>"
              class="pl-8 w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              placeholder="Minimum selling price">
          </div>
        </div>

        <div><!-- Spacer for layout balance if needed, or collapse grid --></div>

        <!-- Row 3: Dates -->
        <div>
          <label class="font-medium block mb-2 text-gray-700">Auction Starts At <span
              class="text-red-500">*</span></label>
          <input type="datetime-local" id="auctionStartsAt" name="auctionStartsAt"
            value="<%= property?.auctionStartsAt ? new Date(property.auctionStartsAt).toISOString().slice(0,16) : '' %>"
            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="font-medium block mb-2 text-gray-700">Auction Ends At <span
              class="text-red-500">*</span></label>
          <input type="datetime-local" id="auctionEndsAt" name="auctionEndsAt"
            value="<%= property?.auctionEndsAt ? new Date(property.auctionEndsAt).toISOString().slice(0,16) : '' %>"
            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
        </div>

      </div>

    </section>


    <!------------------- EXISTING MEDIA ----------------------->
    <% if (property && media && media.length> 0) { %>
      <section class="bg-white p-6 border rounded-lg shadow-sm">
        <h3 class="font-bold mb-4">Existing Images</h3>

        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
          <% media.forEach(img=> { %>
            <div id="image-<%= img._id %>" class="relative group">
              <img src="<%= img.url %>" class="w-full h-36 object-cover rounded" />

              <button type="button" onclick="deleteImage('<%= property._id %>', '<%= img._id %>')"
                class="hidden group-hover:block absolute top-1 right-1 bg-red-600 text-white px-2 py-1 text-xs rounded">
                Delete
              </button>
            </div>
            <% }) %>
        </div>
      </section>
      <% } %>



        <!------------------- EXISTING DOCS ----------------------->
        <% if (property && docs && docs.length> 0) { %>
          <section class="bg-white p-6 border rounded-lg shadow-sm mt-4">
            <h3 class="font-bold mb-4">Existing Documents</h3>

            <div class="space-y-2">
              <% docs.forEach(doc=> { %>
                <div id="doc-<%= doc._id %>" class="flex justify-between border rounded p-2 bg-gray-50 items-center">

                  <a href="<%= doc.url %>" class="text-blue-600 underline" target="_blank">
                    <%= doc.name || "Document" %>
                  </a>

                  <button type="button" onclick="deleteDoc('<%= property._id %>', '<%= doc._id %>')"
                    class="bg-red-600 text-white px-3 py-1 text-xs rounded">
                    Delete
                  </button>
                </div>
                <% }) %>
            </div>

          </section>
          <% } %>


            <!-------------------- NEW UPLOADS ------------------------->
            <section class="bg-white p-6 border rounded-lg shadow-sm space-y-3">
              <h3 class="font-bold">Upload Images</h3>
              <input type="file" name="media" id="media" multiple class="border rounded p-2 w-full" />

              <h3 class="font-bold">Upload Documents</h3>
              <input type="file" name="docs" id="docs" multiple class="border rounded p-2 w-full" />
            </section>

            <!-------------------- SUBMIT BUTTON ------------------------->
            <div class="flex justify-end">
              <button type="submit" class="bg-primary text-white px-6 py-2 font-semibold rounded hover:bg-blue-700">
                <%= property ? "Update Property" : "Submit Property" %>
              </button>
            </div>

  </form>
</div>


<!---------------- SCRIPTS -------------------------->

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/zod@3.22.4/lib/index.umd.min.js"></script>
<script defer
  src="https://maps.googleapis.com/maps/api/js?key=<%= googleMapsApiKey %>&libraries=places&callback=initMap">
  </script>


<script>

  const form = document.getElementById("propertyForm");
  const isEditMode = form.dataset.id !== "";


  // ðŸ”¥ Toggle auction fields
  const isAuctionInput = document.getElementById("isAuction");
  const auctionFields = document.querySelectorAll(".auctionFields");

  function updatePricingUI() {
    const inputs = document.querySelectorAll(".auctionFields input"); // Select inputs inside container

    if (isAuctionInput.checked) {
      auctionFields.forEach(f => f.classList.remove("hidden"));
      inputs.forEach(input => input.disabled = false); // Enable inputs (Validation Active)
    } else {
      auctionFields.forEach(f => f.classList.add("hidden"));
      inputs.forEach(input => input.disabled = true); // Disable inputs (Validation Ignored)
    }
  }

  // apply on load
  updatePricingUI();

  // apply when change
  isAuctionInput.addEventListener("change", updatePricingUI);

  // ðŸ“Œ Submit Handler
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // NEW: Force Auction Checkbox
    if (!isAuctionInput.checked) {
      return Swal.fire({
        icon: "warning",
        title: "Action Required",
        text: "Please check 'Enable Auction' to proceed with pricing."
      });
    }

    // VALIDATION
    const title = document.getElementById('title').value.trim();
    if (!title) return Swal.fire({ icon: "error", title: "Validation Error", text: "Title is required" });

    const description = document.getElementById('description').value.trim();
    if (!description) return Swal.fire({ icon: "error", title: "Validation Error", text: "Description is required" });

    const type = document.getElementById('type').value;
    if (!type) return Swal.fire({ icon: "error", title: "Validation Error", text: "Property Type is required" });

    const isAuction = isAuctionInput.checked;
    if (isAuction) {
      if (!document.getElementById('basePrice').value) return Swal.fire({ icon: "error", title: "Validation Error", text: "Base Price is required" });
      if (!document.getElementById('auctionStep').value) return Swal.fire({ icon: "error", title: "Validation Error", text: "Auction Step is required" });
      if (!document.getElementById('auctionReservePrice').value) return Swal.fire({ icon: "error", title: "Validation Error", text: "Reserve Price is required" });

      const start = document.getElementById('auctionStartsAt').value;
      const end = document.getElementById('auctionEndsAt').value;
      if (!start) return Swal.fire({ icon: "error", title: "Validation Error", text: "Auction Start Date is required" });
      if (!end) return Swal.fire({ icon: "error", title: "Validation Error", text: "Auction End Date is required" });
      if (new Date(start) >= new Date(end)) return Swal.fire({ icon: "error", title: "Validation Error", text: "End Date must be after Start Date" });
    }

    const propertyId = form.dataset.id;
    const lat = document.getElementById("geoLat").value.trim();
    const lng = document.getElementById("geoLng").value.trim();

    // Important validation change â¬‡ï¸
    if (!isEditMode && (!lat || !lng)) {
      return Swal.fire({ icon: "error", title: "Pick a location on map" });
    }

    const formData = new FormData(form);
    formData.set("isAuction", isAuctionInput.checked ? "true" : "false");

    let url = "/properties/create";
    let method = "POST";

    if (isEditMode) {
      url = `/properties/update/${propertyId}`;
      method = "PATCH";
    }


    const res = await fetch(url, {
      method,
      body: formData,
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      }
    });

    // Handle CSRF/Session mismatch
    if (res.status === 403) {
      return Swal.fire({
        icon: 'warning',
        title: 'Session Expired',
        text: 'Your session or security token has expired. reloading page...',
        timer: 2000,
        showConfirmButton: false
      }).then(() => location.reload());
    }

    let data;
    try {
      data = await res.json();
    } catch (err) {
      console.error("Non-JSON response:", err);
      return Swal.fire({ icon: "error", title: "Server Error", text: "Received invalid response from server." });
    }


    if (!data.success) {
      return Swal.fire({ icon: "error", title: "Submission Failed", text: data.message || "Something went wrong" });
    }

    Swal.fire({ icon: "success", title: isEditMode ? "Updated!" : "Submitted!" })
      .then(() => window.location.href = "/user/manage/propertyStatus");
  });


  // ðŸ“Œ Load Google Map & restore previous location
  let map, marker;
  function initMap() {
    const storedLat = parseFloat(document.getElementById("geoLat").value);
    const storedLng = parseFloat(document.getElementById("geoLng").value);

    const defaultPos = (!isNaN(storedLat) && !isNaN(storedLng))
      ? { lat: storedLat, lng: storedLng }
      : { lat: 10.1632, lng: 76.6413 };

    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 12,
      center: defaultPos,
    });

    marker = new google.maps.Marker({
      map,
      position: defaultPos,
      draggable: true,
    });

    marker.addListener("dragend", updateLatLng);

    map.addListener("click", (e) => {
      marker.setPosition(e.latLng);
      updateLatLng();
    });

    function updateLatLng() {
      const pos = marker.getPosition();
      document.getElementById("geoLat").value = pos.lat().toFixed(6);
      document.getElementById("geoLng").value = pos.lng().toFixed(6);
    }
  }


</script>

<script>
  async function deleteImage(propertyId, mediaId) {

    const result = await Swal.fire({
      title: "Delete this image?",
      text: "This action cannot be undone.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, delete",
      cancelButtonText: "Cancel",
      reverseButtons: true
    });

    if (!result.isConfirmed) {
      return;
    }

    // Show loading dialog
    Swal.fire({
      title: "Deleting...",
      text: "Please wait",
      allowOutsideClick: false,
      allowEscapeKey: false,
      didOpen: () => Swal.showLoading(),
    });

    try {
      const res = await fetch(`/user/manage/property/delete-media/${propertyId}/${mediaId}`, {
        method: "DELETE",
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
      });

      const data = await res.json();

      if (data.success) {
        const el = document.getElementById(`image-${mediaId}`);
        if (el) el.remove();

        Swal.fire({
          icon: "success",
          title: "Deleted",
          text: "Image deleted successfully",
          timer: 1300,
          showConfirmButton: false,
        });
      } else {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: data.message || "Failed to delete image",
        });
      }
    } catch (err) {
      console.error("ðŸš¨ Delete image error:", err);
      Swal.fire({
        icon: "error",
        title: "Server Error",
        text: "Something went wrong. Try again later.",
      });
    }
  }

  async function deleteDoc(propertyId, docId) {

    const result = await Swal.fire({
      title: "Delete this document?",
      text: "This action cannot be undone.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, delete",
      cancelButtonText: "Cancel",
      reverseButtons: true
    });

    if (!result.isConfirmed) {
      return;
    }

    Swal.fire({
      title: "Deleting...",
      text: "Please wait",
      allowOutsideClick: false,
      allowEscapeKey: false,
      didOpen: () => Swal.showLoading(),
    });

    try {
      const res = await fetch(`/user/manage/property/delete-doc/${propertyId}/${docId}`, {
        method: "DELETE",
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
      });

      const data = await res.json();

      if (data.success) {
        const el = document.getElementById(`doc-${docId}`);
        if (el) el.remove();

        Swal.fire({
          icon: "success",
          title: "Deleted",
          text: "Document deleted successfully",
          timer: 1300,
          showConfirmButton: false,
        });
      } else {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: data.message || "Failed to delete document",
        });
      }
    } catch (err) {
      console.error("ðŸš¨ Delete doc error:", err);
      Swal.fire({
        icon: "error",
        title: "Server Error",
        text: "Something went wrong. Try again later.",
      });
    }
  }
</script>