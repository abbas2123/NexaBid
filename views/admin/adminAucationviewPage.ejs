<h1 class="text-2xl font-bold mb-4">Live Auction (Admin) - Property: <%= property.title %></h1>

<p class="text-sm text-gray-500 mb-4">Seller: <%= property.sellerId?.name %></p>

<p class="text-xl font-bold text-green-600 mb-4">
  Current Highest Bid: â‚¹<span id="currentBid">
    <%= currentHighestBid.toLocaleString("en-IN") %>
  </span>
</p>

<% if (auctionStatus==="live" ) { %>
<p id="countdown" class="text-lg font-bold text-red-600"></p>
<% } else if (auctionStatus==="ended" ) { %>
<div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
  <h3 class="text-lg font-bold text-green-800 mb-2">ðŸŽ‰ Auction Winner</h3>
  <% if (highestBidder) { %>
  <div class="text-sm text-gray-700 space-y-1">
    <p>
      <span class="font-semibold">Name:</span>
      <%= highestBidder.name %>
    </p>
    <p>
      <span class="font-semibold">Email:</span>
      <%= highestBidder.email %>
    </p>
    <p>
      <span class="font-semibold">Phone:</span>
      <%= highestBidder.phone || 'N/A' %>
    </p>
    <p>
      <span class="font-semibold">Winning Bid:</span> â‚¹<%= currentHighestBid.toLocaleString("en-IN")
      %>
    </p>
  </div>
  <% } else { %>
  <p class="text-gray-500">No winner declared (No bids received).</p>
  <% } %>
</div>
<% } else if (auctionStatus==="upcoming" ) { %>
<p class="text-lg font-bold text-blue-600">Auction Not Started Yet</p>
<% } %>

<table class="w-full text-sm mt-6 border">
  <thead>
    <tr class="bg-gray-100">
      <th class="p-2">Bidder</th>
      <th class="p-2">Amount</th>
      <th class="p-2">Time</th>
    </tr>
  </thead>
  <tbody id="bidFeed">
    <% bids.forEach(bid=> { %>
    <tr>
      <td class="p-2"><%= bid.bidderId?.name || "User" %></td>
      <td class="p-2 font-bold">â‚¹ <%= bid.amount.toLocaleString("en-IN") %></td>
      <td class="p-2"><%= new Date(bid.createdAt).toLocaleTimeString() %></td>
    </tr>
    <% }) %>
  </tbody>
</table>

<script src="/socket.io/socket.io.js"></script>
<script>
  const propertyId = '<%= propertyId %>';

  const socket = io({
    transports: ['websocket'],
    withCredentials: true,
  });

  socket.on('connect', () => {
    console.log('ðŸŸ¢ Admin connected');

    socket.emit('join_auction', { propertyId }, (res) => {
      console.log('ðŸŸ£ Joined:', res);
    });
  });

  socket.on('new_bid', (data) => {
    console.log('ðŸ“© new bid', data);

    document.getElementById('currentBid').textContent = Number(data.amount).toLocaleString('en-IN');

    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="p-2">${data.bidderName}</td>
      <td class="p-2 font-bold">â‚¹ ${Number(data.amount).toLocaleString('en-IN')}</td>
      <td class="p-2">${new Date(data.time).toLocaleTimeString()}</td>
    `;
    document.getElementById('bidFeed').prepend(row);
  });

  socket.on('auction_extended', (d) => {
    window.auctionEndTime = new Date(d.newEndTime).getTime();
  });
</script>

<% if (auctionStatus==="live" ) { %>
<script>
  // Store end time globally so it can be updated by auction_extended event
  window.auctionEndTime = new Date('<%= auctionEndsAt %>').getTime();
  const el = document.getElementById('countdown');

  const updateCountdown = () => {
    const diff = window.auctionEndTime - Date.now();

    if (diff <= 0) {
      el.innerText = 'Auction Ended';
      el.classList.remove('text-red-600');
      el.classList.add('text-gray-600');
      clearInterval(countdownInterval);
      return;
    }

    const hours = Math.floor(diff / 3600000);
    const minutes = Math.floor((diff % 3600000) / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);

    if (hours > 0) {
      el.innerText = `Ends in ${hours}h ${minutes}m ${seconds}s`;
    } else {
      el.innerText = `Ends in ${minutes}m ${seconds}s`;
    }

    // Change color when less than 2 minutes remaining (last minute window)
    if (diff <= 120000) {
      el.classList.add('animate-pulse');
    }
  };

  // Update immediately
  updateCountdown();

  // Then update every second
  const countdownInterval = setInterval(updateCountdown, 1000);
</script>
<% } %>

<style>
  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }

    50% {
      opacity: 0.5;
    }
  }

  .animate-pulse {
    animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
</style>
