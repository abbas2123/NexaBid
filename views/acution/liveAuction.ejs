<body
  class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark font-sans antialiased min-h-screen">
  <!-- ================= AUCTION STATUS HEADER ================= -->
  <div class="max-w-7xl mx-auto px-4 py-6 text-center">
    <h1 class="text-3xl font-bold mb-2">Live Property Auction</h1>
    <p id="auctionStatusText" class="text-lg font-medium text-primary"></p>
  </div>

  <!-- ================= COUNTDOWN ================= -->
  <div id="countdownWrapper" class="max-w-2xl mx-auto grid grid-cols-4 gap-4 text-center mb-10">
    <div class="bg-blue-50 dark:bg-slate-800 rounded-lg py-4">
      <span id="days" class="block text-3xl font-bold">00</span>
      <span class="text-sm">Days</span>
    </div>
    <div class="bg-blue-50 dark:bg-slate-800 rounded-lg py-4">
      <span id="hours" class="block text-3xl font-bold">00</span>
      <span class="text-sm">Hours</span>
    </div>
    <div class="bg-blue-50 dark:bg-slate-800 rounded-lg py-4">
      <span id="minutes" class="block text-3xl font-bold">00</span>
      <span class="text-sm">Minutes</span>
    </div>
    <div class="bg-blue-50 dark:bg-slate-800 rounded-lg py-4">
      <span id="seconds" class="block text-3xl font-bold">00</span>
      <span class="text-sm">Seconds</span>
    </div>
  </div>

  <!-- ================= LIVE BID SECTION ================= -->
  <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-10">
    <!-- LEFT -->
    <div class="lg:col-span-7 space-y-6">
      <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border mb-4">
        <div class="flex justify-between items-center">
          <span>Base Price</span>
          <span class="text-xl font-bold text-gray-700">
            â‚¹ <%= basePrice.toLocaleString("en-IN") %>
          </span>
        </div>
      </div>
      <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border">
        <div class="flex justify-between items-center border-b pb-4 mb-4">
          <span>Current Highest Bid</span>
          <div class="text-right">
            <span id="currentBid" class="block text-2xl font-bold text-primary">
              â‚¹ <%= (currentHighestBid || 0).toLocaleString("en-IN") %>
            </span>
            <span id="highestBidderName" class="text-xs text-gray-500 font-medium">
              <%= property.currentHighestBidder ? property.currentHighestBidder.name : 'No bids yet' %>
            </span>
          </div>
        </div>
        <p class="text-sm text-gray-500">
          Next minimum bid: â‚¹ <%= ((currentHighestBid || 0) + auctionStep).toLocaleString("en-IN") %>
        </p>
      </div>

      <!-- BID FORM -->
      <div class="bg-white dark:bg-slate-900 p-6 rounded-xl border">
        <input id="bidAmount" type="number" class="w-full mb-4 px-4 py-3 rounded border text-lg"
          placeholder="Enter your bid" disabled />

        <div class="flex gap-4">
          <button id="autoBidBtn" class="flex-1 px-4 py-3 rounded bg-gray-200 cursor-not-allowed" disabled>
            Auto Bid
          </button>

          <button id="placeBidBtn" class="flex-1 px-4 py-3 rounded bg-primary text-white font-bold cursor-not-allowed"
            disabled>
            Place Bid
          </button>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="lg:col-span-5">
      <h2 class="text-xl font-bold mb-4">Live Bid Feed</h2>
      <div id="bidFeed" class="space-y-3 max-h-[400px] overflow-y-auto"></div>
    </div>
  </div>

  <!-- ================= SCRIPT ================= -->
  <script>
    document.getElementById('autoBidBtn').addEventListener('click', () => {
      window.location.href = `/auctions/auto-bid/<%= propertyId %>`;
    });
  </script>
  <script>
    const auctionStartsAt = new Date('<%= auctionStartsAt %>').getTime();
    let auctionEndsAt = new Date('<%= auctionEndsAt %>').getTime();

    const statusText = document.getElementById('auctionStatusText');
    const bidInput = document.getElementById('bidAmount');
    const placeBtn = document.getElementById('placeBidBtn');
    const autoBtn = document.getElementById('autoBidBtn');

    function updateCountdown() {
      const now = new Date().getTime();
      let diff;
      let label = '';

      if (now < auctionStartsAt) {
        diff = auctionStartsAt - now;
        label = 'Auction not started';
        disableBidding();
      } else if (now >= auctionStartsAt && now < auctionEndsAt) {
        diff = auctionEndsAt - now;
        label = 'Auction is LIVE ðŸ”´';
        enableBidding();
      } else {
        statusText.innerText = 'Auction ended';
        disableBidding();
        return;
      }

      statusText.innerText = label;

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const minutes = Math.floor((diff / (1000 * 60)) % 60);
      const seconds = Math.floor((diff / 1000) % 60);

      document.getElementById('days').innerText = days;
      document.getElementById('hours').innerText = hours;
      document.getElementById('minutes').innerText = minutes;
      document.getElementById('seconds').innerText = seconds;
    }

    function enableBidding() {
      bidInput.disabled = false;
      placeBtn.disabled = false;
      autoBtn.disabled = false;
      placeBtn.classList.remove('cursor-not-allowed');
      autoBtn.classList.remove('cursor-not-allowed');
    }

    function disableBidding() {
      bidInput.disabled = true;
      placeBtn.disabled = true;
      autoBtn.disabled = true;
      placeBtn.classList.add('cursor-not-allowed');
      autoBtn.classList.add('cursor-not-allowed');
    }

    setInterval(updateCountdown, 1000);
    updateCountdown();
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    const auctionSocket = io("<%= process.env.SOCKET_URL || 'http://localhost:3000' %>", {
      withCredentials: true
    });

    let currentHighestBid = <%= currentHighestBid || 0 %>;
    const basePrice = <%= basePrice %>;
    const auctionStep = <%= auctionStep %>;
    let myAutoBidMax = <%= (typeof myAutoBidMax !== 'undefined' ? myAutoBidMax : 0) %>;

    auctionSocket.emit("join_auction", {
      propertyId: "<%= propertyId %>",
      userId: "<%= user._id %>"
    });

    document.getElementById("placeBidBtn").addEventListener("click", () => {
      const bidValue = Number(document.getElementById("bidAmount").value);
      let minAllowed;
      let maxAllowed = null;

      if (currentHighestBid === 0) {
        minAllowed = basePrice + 1;
      } else {
        minAllowed = currentHighestBid + 1;
        maxAllowed = currentHighestBid + auctionStep;
      }

      if (bidValue < minAllowed || (maxAllowed && bidValue > maxAllowed)) {
        Swal.fire({
          icon: "error",
          title: "Invalid Bid",
          text: maxAllowed
            ? `Bid must be between â‚¹${minAllowed} and â‚¹${maxAllowed}`
            : `Bid must be greater than â‚¹${basePrice}`,
        });
        return;
      }

      auctionSocket.emit("place_bid", {
        propertyId: "<%= propertyId %>",
        amount: bidValue,
      });
    });

    auctionSocket.on("new_bid", (data) => {
      currentHighestBid = data.amount;
      document.getElementById("currentBid").innerText =
        "â‚¹ " + data.amount.toLocaleString("en-IN");

      // UPDATE HIGHEST BIDDER NAME
      const nameEl = document.getElementById("highestBidderName");
      if (nameEl) nameEl.innerText = data.bidderName;

      const feed = document.getElementById("bidFeed");
      const div = document.createElement("div");
      div.className = "p-3 rounded bg-blue-50 border-l-4 border-primary";
      div.innerHTML = `<strong>New Bid:</strong> â‚¹${data.amount.toLocaleString("en-IN")}`;
      feed.prepend(div);

      // Auto Bid Limit Check
      if (myAutoBidMax > 0 && data.amount >= myAutoBidMax && data.bidderId !== "<%= user._id %>") {
        Swal.fire({
          icon: 'warning',
          title: 'Auto Bid Limit Exceeded âš ï¸',
          text: `The current bid of â‚¹${data.amount} has reached or exceeded your auto-bid limit of â‚¹${myAutoBidMax}.`,
          showCancelButton: true,
          confirmButtonText: 'Increase Limit',
          confirmButtonColor: '#d33',
          cancelButtonText: 'Dismiss'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = `/auctions/auto-bid/<%= propertyId %>`;
          }
        });
        myAutoBidMax = 0; // Don't show again for this session
      }
    });

    auctionSocket.on("auction_ended", async () => {
      const res = await fetch(`/auctions/result/<%= propertyId %>`);
      const data = await res.json();

      if (data.result === "won") {
        window.location.href = `/auctions/success/<%= propertyId %>`;
      } else {
        window.location.href = `/auctions/failed/<%= propertyId %>`;
      }
    });
    auctionSocket.on('bid_error', (data) => {
      Swal.fire({
        icon: 'error',
        title: 'Bid Too Low',
        text: data.message,
        confirmButtonColor: '#1d72d6',
      });
    });

    auctionSocket.on('auction_extended', (data) => {
      Swal.fire({
        icon: 'info',
        title: 'Auction Extended â°',
        text: `Auction extended by ${data.extendedBy} minutes`,
        timer: 2500,
        showConfirmButton: false,
      });

      // Update countdown end time
      auctionEndsAt = new Date(data.newEndTime).getTime();
    });

    auctionSocket.on('newNotification', (data) => {
      if (data.type === 'won' || (data.message && data.message.includes('won'))) {
        Swal.fire({
          icon: 'success',
          title: 'ðŸŽ‰ You won the auction!',
          text: data.message || `Winning bid: â‚¹${(data.amount || 0).toLocaleString('en-IN')}`,
          timer: 3000,
          showConfirmButton: true,
        }).then(() => {
          window.location.href = `/auctions/success/${data.propertyId || '<%= propertyId %>'}`;
        });
      } else {
        Swal.fire({
          icon: 'info',
          title: 'Notification',
          text: data.message,
          timer: 3000,
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
        });
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get('error');

      if (error === 'auto_bid_too_low') {
        Swal.fire({
          icon: 'error',
          title: 'Auto Bid Limit Too Low',
          text: 'Your max bid amount must be higher than the current highest bid.',
          confirmButtonColor: '#d33',
        });
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    });
  </script>
</body>