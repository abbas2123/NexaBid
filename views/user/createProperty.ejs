<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-0 py-6 sm:py-8">

  <!-- Page Title -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900 dark:text-white">
      <%= property ? "Update Property" : "List a New Property" %>
    </h1>

    <a href="/properties" class="text-sm px-3 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">
      Back
    </a>
  </div>


  <!------------------------------ FORM ----------------------------->
  <form id="propertyForm" data-id="<%= property?._id || '' %>" enctype="multipart/form-data" class="space-y-8">

    <!---------------- PROPERTY DETAILS ---------------->
    <section class="bg-white p-6 shadow-sm rounded-lg border">
      <h2 class="text-lg font-bold mb-4">Property Details</h2>

      <div class="space-y-4">
        <div>
          <label>Title *</label>
          <input required name="title" id="title" value="<%= property?.title || '' %>"
            class="w-full border rounded p-2" />
        </div>

        <div>
          <label>Description *</label>
          <textarea name="description" id="description" rows="4"
            class="w-full border rounded p-2"><%= property?.description || '' %></textarea>
        </div>

        <div>
          <label>Type *</label>
          <select name="type" id="type" class="w-full border rounded p-2">
            <option value="">Select</option>
            <option value="house" <%=property?.type==="house" ? "selected" : "" %>>House</option>
            <option value="apartment" <%=property?.type==="apartment" ? "selected" : "" %>>Apartment</option>
            <option value="land" <%=property?.type==="land" ? "selected" : "" %>>Land</option>
            <option value="commercial" <%=property?.type==="commercial" ? "selected" : "" %>>Commercial</option>
          </select>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <input placeholder="BHK" name="bhk" id="bhk" value="<%= property?.bhk || '' %>" class="border rounded p-2" />
          <input placeholder="Size in sqft" name="size" id="size" value="<%= property?.size || '' %>"
            class="border rounded p-2" />
        </div>

      </div>
    </section>


    <!------------------------- LOCATION ------------------------------>
    <section class="bg-white p-6 shadow-sm rounded-lg border space-y-4">
      <h2 class="text-lg font-bold mb-4">Location</h2>

      <input name="address" id="address" value="<%= property?.address || '' %>" placeholder="Enter address"
        class="w-full border rounded p-2" />

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <input placeholder="State" name="locationState" id="locationState" value="<%= property?.locationState || '' %>"
          class="border rounded p-2" />

        <input placeholder="District" name="locationDistrict" id="locationDistrict"
          value="<%= property?.locationDistrict || '' %>" class="border rounded p-2" />
      </div>

      <p class="text-sm font-semibold mt-2">
        Click on the map to select location
      </p>

      <div id="map" class="w-full h-64 rounded bg-gray-300"></div>

      <div class="grid grid-cols-2 gap-4 mt-2">
        <input readonly name="geoLat" id="geoLat" value="<%= property?.geoLat || '' %>" class="border rounded p-2" />
        <input readonly name="geoLng" id="geoLng" value="<%= property?.geoLng || '' %>" class="border rounded p-2" />
      </div>
    </section>


    <!------------------------ PRICING ------------------------------>
    <section class="bg-white p-6 shadow-sm rounded-lg border space-y-6">

      <div class="flex justify-between items-center">
        <h2 class="text-lg font-bold">Pricing</h2>

        <label class="flex items-center gap-2 text-sm">
          <span>Auction?</span>
          <input name="isAuction" id="isAuction" type="checkbox" <%=property?.isAuction ? "checked" : "" %> />
        </label>
      </div>

      <!-- AUCTION FIELDS -->
      <div class="auctionFields grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="font-medium block mb-1">Base Price *</label>
          <input type="number" id="basePrice" name="basePrice" value="<%= property?.basePrice || '' %>"
            class="border rounded-lg p-2 w-full">
        </div>

        <div>
          <label class="font-medium block mb-1">Auction Step *</label>
          <input type="number" id="auctionStep" name="auctionStep" value="<%= property?.auctionStep || '' %>"
            class="border rounded-lg p-2 w-full">
        </div>
      </div>

      <div class="auctionFields grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="font-medium block mb-1">Reserve Price *</label>
          <input type="number" id="auctionReservePrice" name="auctionReservePrice"
            value="<%= property?.auctionReservePrice || '' %>" class="border rounded-lg p-2 w-full">
        </div>

        <div>
          <label class="font-medium block mb-1">Auction Starts At</label>
          <input type="datetime-local" id="auctionStartsAt" name="auctionStartsAt"
            value="<%= property?.auctionStartsAt ? new Date(property.auctionStartsAt).toISOString().slice(0,16) : '' %>"
            class="border rounded-lg p-2 w-full">
        </div>
      </div>

      <div class="auctionFields grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="font-medium block mb-1">Auction Ends At</label>
          <input type="datetime-local" id="auctionEndsAt" name="auctionEndsAt"
            value="<%= property?.auctionEndsAt ? new Date(property.auctionEndsAt).toISOString().slice(0,16) : '' %>"
            class="border rounded-lg p-2 w-full">
        </div>
      </div>

    </section>


    <!------------------- EXISTING MEDIA ----------------------->
    <% if (property && media && media.length> 0) { %>
      <section class="bg-white p-6 border rounded-lg shadow-sm">
        <h3 class="font-bold mb-4">Existing Images</h3>

        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
          <% media.forEach(img=> { %>
            <div id="image-<%= img._id %>" class="relative group">
              <img src="<%= img.url %>" class="w-full h-36 object-cover rounded" />

              <button type="button" onclick="deleteImage('<%= property._id %>', '<%= img._id %>')"
                class="hidden group-hover:block absolute top-1 right-1 bg-red-600 text-white px-2 py-1 text-xs rounded">
                Delete
              </button>
            </div>
            <% }) %>
        </div>
      </section>
      <% } %>



        <!------------------- EXISTING DOCS ----------------------->
        <% if (property && docs && docs.length> 0) { %>
          <section class="bg-white p-6 border rounded-lg shadow-sm mt-4">
            <h3 class="font-bold mb-4">Existing Documents</h3>

            <div class="space-y-2">
              <% docs.forEach(doc=> { %>
                <div id="doc-<%= doc._id %>" class="flex justify-between border rounded p-2 bg-gray-50 items-center">

                  <a href="<%= doc.url %>" class="text-blue-600 underline" target="_blank">
                    <%= doc.name || "Document" %>
                  </a>

                  <button type="button" onclick="deleteDoc('<%= property._id %>', '<%= doc._id %>')"
                    class="bg-red-600 text-white px-3 py-1 text-xs rounded">
                    Delete
                  </button>
                </div>
                <% }) %>
            </div>

          </section>
          <% } %>


            <!-------------------- NEW UPLOADS ------------------------->
            <section class="bg-white p-6 border rounded-lg shadow-sm space-y-3">
              <h3 class="font-bold">Upload Images</h3>
              <input type="file" name="media" id="media" multiple class="border rounded p-2 w-full" />

              <h3 class="font-bold">Upload Documents</h3>
              <input type="file" name="docs" id="docs" multiple class="border rounded p-2 w-full" />
            </section>

            <!-------------------- SUBMIT BUTTON ------------------------->
            <div class="flex justify-end">
              <button type="submit" class="bg-primary text-white px-6 py-2 font-semibold rounded hover:bg-blue-700">
                <%= property ? "Update Property" : "Submit Property" %>
              </button>
            </div>

  </form>
</div>


<!---------------- SCRIPTS -------------------------->

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script defer
  src="https://maps.googleapis.com/maps/api/js?key=<%= googleMapsApiKey %>&libraries=places&callback=initMap">
  </script>


<script>
  console.log("ðŸš€ JS Loaded");

  const form = document.getElementById("propertyForm");
  const isEditMode = form.dataset.id !== "";
  console.log("Edit Mode?", isEditMode);


  // ðŸ”¥ Toggle auction fields
  const isAuctionInput = document.getElementById("isAuction");
  const auctionFields = document.querySelectorAll(".auctionFields");

  function updatePricingUI() {
    if (isAuctionInput.checked) {
      auctionFields.forEach(f => f.classList.remove("hidden"));
      // buyNowPrice.disabled = true;
    } else {
      auctionFields.forEach(f => f.classList.add("hidden"));
      // buyNowPrice.disabled = false;
    }
  }

  // apply on load
  updatePricingUI();

  // apply when change
  isAuctionInput.addEventListener("change", updatePricingUI);

  // ðŸ“Œ Submit Handler
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    console.log("ðŸ”¥ SUBMIT STARTED");
    const propertyId = form.dataset.id;
    const lat = document.getElementById("geoLat").value.trim();
    const lng = document.getElementById("geoLng").value.trim();

    // Important validation change â¬‡ï¸
    if (!isEditMode && (!lat || !lng)) {
      return Swal.fire({ icon: "error", title: "Pick a location on map" });
    }

    const formData = new FormData(form);
    formData.set("isAuction", isAuctionInput.checked ? "true" : "false");

    let url = "/properties/create";
    let method = "POST";

    if (isEditMode) {
      url = `/properties/update/${propertyId}`;
      method = "PATCH";
    }

    console.log("ðŸ“Œ Sending â†’", method, url);

    const res = await fetch(url, { method, body: formData });
    const data = await res.json();

    console.log("ðŸ›¬ API Response:", data);

    if (!data.success) {
      return Swal.fire({ icon: "error", title: data.message || "Something failed" });
    }

    Swal.fire({ icon: "success", title: isEditMode ? "Updated!" : "Submitted!" })
      .then(() => window.location.href = "/user/status/propertyStatus");
  });


  // ðŸ“Œ Load Google Map & restore previous location
  let map, marker;
  function initMap() {
    const storedLat = parseFloat(document.getElementById("geoLat").value);
    const storedLng = parseFloat(document.getElementById("geoLng").value);

    const defaultPos = (!isNaN(storedLat) && !isNaN(storedLng))
      ? { lat: storedLat, lng: storedLng }
      : { lat: 10.1632, lng: 76.6413 };

    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 12,
      center: defaultPos,
    });

    marker = new google.maps.Marker({
      map,
      position: defaultPos,
      draggable: true,
    });

    marker.addListener("dragend", updateLatLng);

    map.addListener("click", (e) => {
      marker.setPosition(e.latLng);
      updateLatLng();
    });

    function updateLatLng() {
      const pos = marker.getPosition();
      document.getElementById("geoLat").value = pos.lat().toFixed(6);
      document.getElementById("geoLng").value = pos.lng().toFixed(6);
    }
  }


</script>

<script>
  async function deleteImage(propertyId, mediaId) {
    console.log("ðŸ§¹ deleteImage called", propertyId, mediaId);

    const result = await Swal.fire({
      title: "Delete this image?",
      text: "This action cannot be undone.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, delete",
      cancelButtonText: "Cancel",
      reverseButtons: true
    });

    if (!result.isConfirmed) {
      console.log("âŒ Delete image cancelled");
      return;
    }

    // Show loading dialog
    Swal.fire({
      title: "Deleting...",
      text: "Please wait",
      allowOutsideClick: false,
      allowEscapeKey: false,
      didOpen: () => Swal.showLoading(),
    });

    try {
      const res = await fetch(`/user/status/property/delete-media/${propertyId}/${mediaId}`, {
        method: "DELETE",
      });

      const data = await res.json();
      console.log("ðŸ›¬ Delete image response:", data);

      if (data.success) {
        const el = document.getElementById(`image-${mediaId}`);
        if (el) el.remove();

        Swal.fire({
          icon: "success",
          title: "Deleted",
          text: "Image deleted successfully",
          timer: 1300,
          showConfirmButton: false,
        });
      } else {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: data.message || "Failed to delete image",
        });
      }
    } catch (err) {
      console.error("ðŸš¨ Delete image error:", err);
      Swal.fire({
        icon: "error",
        title: "Server Error",
        text: "Something went wrong. Try again later.",
      });
    }
  }

  async function deleteDoc(propertyId, docId) {
    console.log("ðŸ§¹ deleteDoc called", propertyId, docId);

    const result = await Swal.fire({
      title: "Delete this document?",
      text: "This action cannot be undone.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, delete",
      cancelButtonText: "Cancel",
      reverseButtons: true
    });

    if (!result.isConfirmed) {
      console.log("âŒ Delete doc cancelled");
      return;
    }

    Swal.fire({
      title: "Deleting...",
      text: "Please wait",
      allowOutsideClick: false,
      allowEscapeKey: false,
      didOpen: () => Swal.showLoading(),
    });

    try {
      const res = await fetch(`/user/status/property/delete-doc/${propertyId}/${docId}`, {
        method: "DELETE",
      });

      const data = await res.json();
      console.log("ðŸ›¬ Delete doc response:", data);

      if (data.success) {
        const el = document.getElementById(`doc-${docId}`);
        if (el) el.remove();

        Swal.fire({
          icon: "success",
          title: "Deleted",
          text: "Document deleted successfully",
          timer: 1300,
          showConfirmButton: false,
        });
      } else {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: data.message || "Failed to delete document",
        });
      }
    } catch (err) {
      console.error("ðŸš¨ Delete doc error:", err);
      Swal.fire({
        icon: "error",
        title: "Server Error",
        text: "Something went wrong. Try again later.",
      });
    }
  }
</script>