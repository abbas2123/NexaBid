<div>
  <h1 class="text-2xl font-bold mb-6">Tender Management</h1>

  <!-- FILTERS -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">

    <!-- Search -->
    <input 
      id="tenderSearchInput"
      type="text"
      placeholder="Search by tender title, department, vendor..."
      class="w-full md:w-1/2 border rounded px-3 py-2"
    />

    <!-- Status Filter -->
    <select id="tenderStatusFilter"
      class="w-full md:w-48 border px-3 py-2 rounded">
      <option value="">All Status</option>
      <option value="draft">Draft</option>
      <option value="submitted">Submitted</option>
      <option value="published">Published</option>
      <option value="rejected">Rejected</option>
      <option value="closed">Closed</option>
    </select>
  </div>


  <!-- TABLE -->
  <div class="bg-white rounded-lg border p-4 overflow-x-auto">
    <table class="w-full text-left">
      <thead>
        <tr class="text-gray-600 border-b">
          <th class="py-3">Title</th>
          <th class="py-3">Department</th>
          <th class="py-3">Vendor</th>
          <th class="py-3">Bid End Date</th>
          <th class="py-3">Status</th>
          <th class="py-3">Action</th>
        </tr>
      </thead>

      <tbody>
        <% if (!tenders || tenders.length === 0) { %>
          <tr>
            <td colspan="6" class="py-6 text-center text-gray-500">
              No tenders found.
            </td>
          </tr>
        <% } else { %>
          <% tenders.forEach(t => { %>
            <tr class="border-b hover:bg-gray-50">

              <!-- Title -->
              <td class="py-3 font-semibold"><%= t.title %></td>

              <!-- Department -->
              <td><%= t.dept %></td>

              <!-- Vendor -->
              <td><%= t.createdBy?.name || "Unknown Vendor" %></td>

              <!-- Bid End -->
              <td>
                <%= t.bidEndAt ? new Date(t.bidEndAt).toDateString() : "N/A" %>
              </td>

              <!-- Status -->
             <td>
  <% if (t.status === "draft") { %>
    <span class="px-3 py-1 bg-yellow-200 text-yellow-800 rounded">Draft</span>

  <% } else if (t.status === "submitted") { %>
    <span class="px-3 py-1 bg-blue-200 text-blue-800 rounded">Submitted</span>

  <% } else if (t.status === "published") { %>
    <span class="px-3 py-1 bg-green-200 text-green-800 rounded">Published</span>

  <% } else if (t.status === "awarded") { %>
    <span class="px-3 py-1 bg-purple-200 text-purple-800 rounded">
      Awarded
    </span>

  <% } else if (t.status === "closed") { %>
    <span class="px-3 py-1 bg-gray-300 text-gray-700 rounded">Closed</span>

  <% } else if (t.status === "rejected") { %>
    <span class="px-3 py-1 bg-red-200 text-red-700 rounded">Rejected</span>

  <% } else { %>
    <span class="px-3 py-1 bg-gray-100 text-gray-500 rounded">
      Unknown
    </span>
  <% } %>
</td>

              <!-- Actions -->
              <td>
                <button class="tender-review-btn text-blue-600 font-semibold"
                        data-id="<%= t._id %>">
                  Review
                </button>
              </td>

            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
</div>


<!-- REVIEW MODAL -->
<div id="tenderModal"
  class="fixed inset-0 bg-black bg-opacity-40 hidden justify-center items-center z-50 px-4">

  <div class="bg-white w-full max-w-2xl rounded-lg shadow-lg relative">

    <!-- Header -->
    <div class="flex justify-between items-center p-4 border-b sticky top-0 bg-white">
      <h2 class="text-xl font-bold">Tender Review</h2>
      <button id="tenderCloseModal"
        class="text-gray-700 text-xl font-bold hover:text-black">âœ–</button>
    </div>

    <!-- Scrollable Content -->
    <div class="p-4 overflow-y-auto max-h-[60vh] space-y-4">
      <div id="tenderReviewContent" class="space-y-3 text-gray-700"></div>

      <div>
        <label class="font-semibold">Admin Comments</label>
        <textarea id="tenderAdminComment"
          class="w-full border rounded px-3 py-2 mt-2"
          rows="3"
          placeholder="Write comments here..."></textarea>
      </div>
    </div>

    <!-- Footer -->
    <div class="flex flex-wrap justify-end gap-3 p-4 border-t sticky bottom-0 bg-white">
      <button id="tenderRejectBtn"
        class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
        Reject
      </button>

      <button id="tenderApproveBtn"
        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
        Approve & Publish
      </button>

      <button id="tenderCloseBtn"
        class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
        Close Tender
      </button>
    </div>

  </div>
</div>
<%- include('../partials/admin/pagination.ejs', { pagination}) %>
<style>.break-message {
  white-space: pre-wrap;
  word-wrap: break-word;
  word-break: break-word;
  overflow-wrap: break-word;
}</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let currentTenderId = null;

async function safeFetch(url, options = {}) {
  const res = await fetch(url, options);
  const text = await res.text();
  try {
    return JSON.parse(text);
  } catch {
    return text;
  }
}

// OPEN MODAL + LOAD TENDER DETAILS
document.querySelectorAll(".tender-review-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    currentTenderId = btn.dataset.id;

    const res = await safeFetch(`/admin/tender-management/${currentTenderId}`);

    if (!res || !res.success || !res.tender) {
      Swal.fire({
        icon: "error",
        title: "Error",
        text: res.message || "Tender details not found",
      });
      return;
    }

    const t = res.tender;

   document.getElementById("tenderReviewContent").innerHTML = `
  <p><b>Title:</b> ${t.title}</p>
  <p><b>Department:</b> ${t.dept}</p>
  <p><b>Description:</b> ${t.description || "-"}</p>
  <p><b>Vendor:</b> ${(t.createdBy?.name || "Unknown")}</p>
  <p><b>Status:</b> ${t.status}</p>
  <p><b>Bid End:</b> ${t.bidEndAt ? new Date(t.bidEndAt).toDateString() : "N/A"}</p>

  ${
  t.adminComment
    ? `
      <div class="w-full break-message border border-red-300 bg-red-50 text-red-600 rounded p-2 text-sm mt-3">
        <b class="text-red-700">Previous Admin Comment</b><br>
        ${t.adminComment}
      </div>`
    : ""
}

 <h3 class="font-semibold mt-4">Documents:</h3>
${
  t.files && t.files.length
    ? t.files.map(d => {
        const file = d.fileId;
        if (!file?.fileUrl) return "";

        let viewUrl = file.fileUrl;

        // Only for PDFs (raw)
        if (file.mimeType === "application/pdf") {
          viewUrl = file.fileUrl.replace(
            "/raw/upload/",
            "/raw/upload/fl_attachment:false/"
          );
        }

        const isImage = file.mimeType?.startsWith("image/");

        return `
          <div class="mt-2">
            <a href="${viewUrl}" target="_blank" class="text-blue-600 underline">
              ${d.originalName || file.fileName}
            </a>
            <span class="text-xs text-gray-500">
              (${(file.size/1024).toFixed(1)} KB)
            </span>

            ${isImage ? `<img src="${viewUrl}" class="mt-2 h-32 rounded border">` : ""}
          </div>
        `;
      }).join("")
    : "<p class='text-gray-400'>No documents uploaded</p>"
}
`;
    document.getElementById("tenderModal").classList.remove("hidden");
    document.getElementById("tenderModal").classList.add("flex");
  });
});

// CLOSE MODAL
document.getElementById("tenderCloseModal").addEventListener("click", () => {
  document.getElementById("tenderModal").classList.add("hidden");
});

// STATUS UPDATE HELPERS
async function updateTenderStatus(status) {
  if (!currentTenderId) return;

  const comment = document.getElementById("tenderAdminComment").value;

  const res = await safeFetch(`/admin/tender-management/status/${currentTenderId}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status, comment }),
  });

  if (!res || !res.success) {
    Swal.fire({
      icon: "error",
      title: "Failed",
      text: res.message || "Could not update tender",
    });
    return;
  }

  Swal.fire({
    icon: "success",
    title: "Updated",
    text: res.message,
  }).then(() => {
    location.reload();
  });
}

// Buttons
document.getElementById("tenderApproveBtn").addEventListener("click", () => {
  updateTenderStatus("published");
});

document.getElementById("tenderRejectBtn").addEventListener("click", () => {
  updateTenderStatus("rejected");
});

document.getElementById("tenderCloseBtn").addEventListener("click", () => {
  updateTenderStatus("closed");
});

// FILTERING
const searchInput = document.getElementById("tenderSearchInput");
const statusFilter = document.getElementById("tenderStatusFilter");

function filterTenders() {
  const s = searchInput.value.toLowerCase();
  const st = statusFilter.value.toLowerCase();

  document.querySelectorAll("tbody tr").forEach((row) => {
    const title = row.children[0]?.innerText.toLowerCase() || "";
    const dept = row.children[1]?.innerText.toLowerCase() || "";
    const vendor = row.children[2]?.innerText.toLowerCase() || "";
    const statusText = row.children[4]?.innerText.toLowerCase() || "";

    const matchSearch =
      title.includes(s) || dept.includes(s) || vendor.includes(s);
    const matchStatus = st === "" || statusText.includes(st);

    row.style.display = matchSearch && matchStatus ? "" : "none";
  });
}

searchInput.addEventListener("input", filterTenders);
statusFilter.addEventListener("change", filterTenders);
</script>