<main class="px-4 sm:px-6 lg:px-8 py-5 w-full flex justify-center">
  <div x-data="{ tab:'technical', modal:false, currentBid:{} }" class="max-w-7xl w-full space-y-10">
    <!-- TITLE -->
    <div>
      <h1 class="text-3xl sm:text-4xl font-black text-gray-900 dark:text-white">
        Tender Evaluation: <%= tender.title %>
      </h1>
      <p class="text-sm text-gray-500 dark:text-gray-300">
        Created On: <%= new Date(tender.createdAt).toLocaleDateString('en-IN') %>
      </p>
    </div>

    <!-- STATS -->
    <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="p-5 bg-white dark:bg-gray-800 border rounded-xl">
        <p class="text-gray-600 text-sm">Total Bids</p>
        <p class="text-3xl font-bold"><%= bids.length %></p>
      </div>

      <div class="p-5 bg-white dark:bg-gray-800 border rounded-xl">
        <p class="text-gray-600 text-sm">Highest Bid</p>
        <p class="text-3xl font-bold text-green-600">
          ₹<%= (Math.max(...bids.map(b=> b.offeredAmount || 0))).toLocaleString('en-IN') %>
        </p>
      </div>

      <div class="p-5 bg-white dark:bg-gray-800 border rounded-xl">
        <p class="text-gray-600 text-sm">Lowest Bid</p>
        <p class="text-3xl font-bold text-red-600">
          ₹<%= (Math.min(...bids.map(b=> b.offeredAmount || 0))).toLocaleString('en-IN') %>
        </p>
      </div>

      <div class="p-5 bg-white dark:bg-gray-800 border rounded-xl">
        <p class="text-gray-600 text-sm">End Date</p>
        <p class="text-3xl font-bold">
          <%= tender.finOpenAt ? new Date(tender.finOpenAt).toLocaleDateString('en-IN') : '—' %>
        </p>
      </div>
    </div>

    <!-- TABS -->
    <nav class="flex gap-8 border-b">
      <button
        @click="tab='technical'"
        :class="tab==='technical' ? 'text-primary border-b-2 border-primary font-bold' : 'text-gray-500'"
        class="pb-3 text-sm"
      >
        Technical Evaluation
      </button>

      <button
        @click="tab='financial'"
        :class="tab==='financial' ? 'text-primary border-b-2 border-primary font-bold' : 'text-gray-500'"
        class="pb-3 text-sm"
      >
        Financial Evaluation
      </button>
    </nav>

    <!-- TECHNICAL TAB -->
    <div
      x-show="tab==='technical'"
      class="overflow-x-auto border rounded-xl bg-white dark:bg-gray-800"
    >
      <table class="w-full border-collapse">
        <thead class="bg-gray-100 text-left text-sm font-semibold">
          <tr>
            <th class="p-4">Bidder</th>
            <th class="p-4">Status</th>
            <th class="p-4">Documents</th>
            <th class="p-4 text-right">Actions</th>
          </tr>
        </thead>

        <tbody>
          <% bids.forEach(b=> { %>

          <!-- SAFE JSON FOR THIS BID -->
          <script type="application/json" id="bid-<%= b._id %>">
            <%- JSON.stringify({
              proposal: { files: (b.proposal?.files || []).map(f => ({ fileName: f.fileName || f.originalName || '', fileUrl: f.fileUrl || '' })) },
              technical: { files: (b.technical?.files || []).map(f => ({ fileName: f.fileName || f.originalName || '', fileUrl: f.fileUrl || '' })) },
              financial: { files: (b.financial?.files || []).map(f => ({ fileName: f.fileName || f.originalName || '', fileUrl: f.fileUrl || '' })) },
              quotes: { amount: b.quotes?.amount || 0, files: (b.quotes?.files || []).map(f => ({ fileName: f.fileName || f.originalName || '', fileUrl: f.fileUrl || '' })) }
            }) %>
          </script>

          <tr class="border-b">
            <td class="p-4 font-semibold"><%= b.vendor.name %></td>
            <td class="p-4">
              <% if (b.techStatus==='accepted' ) { %>
              <span class="px-3 py-1 bg-green-200 text-green-900 rounded-full text-xs font-semibold"
                >Accepted</span
              >
              <% } else if (b.techStatus==='rejected' ) { %>
              <span class="px-3 py-1 bg-red-200 text-red-900 rounded-full text-xs font-semibold"
                >Rejected</span
              >
              <% } else { %>
              <span class="px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-xs font-semibold"
                >Pending</span
              >
              <% } %>
            </td>

            <td class="p-4">
              <button
                @click="
                  modal = true;
                  currentBid = JSON.parse(document.getElementById('bid-<%= b._id %>').textContent);
                  currentBid.tab = 'technical';
                "
                class="underline text-primary font-semibold"
              >
                View Files
              </button>
            </td>

            <td class="p-4 text-right space-x-3">
              <a
                href="/user/manage/my-listing/evaluation/accept-tech/<%= b._id %>"
                class="px-4 py-1 bg-primary text-white rounded-lg text-xs"
                >Accept</a
              >

              <a
                href="/user/manage/my-listing/evaluation/reject-tech/<%= b._id %>"
                class="px-4 py-1 bg-red-600 text-white rounded-lg text-xs"
                >Reject</a
              >
            </td>
          </tr>

          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- FINANCIAL TAB -->
    <div
      x-show="tab==='financial'"
      class="overflow-x-auto border rounded-xl bg-white dark:bg-gray-800"
    >
      <table class="w-full text-sm">
        <thead class="bg-gray-100 font-semibold">
          <tr>
            <th class="p-3 text-left">Bidder</th>
            <th class="p-3 text-center">Amount</th>
            <th class="p-3 text-center">Status</th>
            <th class="p-3 text-center">Documents</th>
            <th class="p-3 text-right">Actions</th>
          </tr>
        </thead>

        <tbody>
          <% bids.filter(b=> b.techStatus === 'accepted').forEach(b => { %>

          <tr class="border-b">
            <td class="p-4 font-semibold"><%= b.vendor.name %></td>

            <td class="p-4 text-center font-bold text-primary">
              ₹<%= Number(b.quotes?.amount || 0).toLocaleString('en-IN') %>
            </td>

            <td class="p-4 text-center">
              <span class="px-3 py-1 bg-green-200 text-green-800 rounded-full text-xs"
                >Qualified</span
              >
            </td>

            <td class="p-4 text-center">
              <button
                @click="
                  modal = true;
                  currentBid = JSON.parse(document.getElementById('bid-<%= b._id %>').textContent);
                  currentBid.tab = 'financial';
                "
                class="underline text-primary font-semibold"
              >
                View Files
              </button>
            </td>

            <td class="p-4 text-right">
              <% if (!b.isWinner) { %>
              <a
                href="/user/manage/my-listing/evaluation/select-winner/<%= b._id %>"
                class="px-4 py-1.5 bg-green-600 text-white rounded-lg text-xs"
                >Select Winner</a
              >
              <% } else { %>
              <span class="px-4 py-1.5 bg-gray-300 text-gray-800 rounded-lg text-xs"
                >Winner Selected</span
              >
              <% } %>
            </td>
          </tr>

          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- DOCUMENT MODAL -->
    <div
      x-show="modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center"
    >
      <div class="bg-white dark:bg-gray-900 p-6 rounded-xl w-full max-w-md space-y-4">
        <div class="flex justify-between">
          <h2 class="text-xl font-bold">Documents</h2>
          <button @click="modal=false" class="text-gray-500">✖</button>
        </div>

        <!-- TECHNICAL -->
        <template x-if="currentBid.tab === 'technical'">
          <div class="space-y-4">
            <h3 class="font-bold">Proposal Documents</h3>
            <template x-for="file in (currentBid.proposal?.files || [])" :key="file.fileUrl">
              <div class="p-3 bg-gray-100 rounded flex justify-between">
                <span x-text="file.fileName || 'Untitled'"></span>
                <a :href="file.fileUrl" class="underline text-primary" target="_blank">Download</a>
              </div>
            </template>

            <h3 class="font-bold">Technical Documents</h3>
            <template x-for="file in (currentBid.technical?.files || [])" :key="file.fileUrl">
              <div class="p-3 bg-gray-100 rounded flex justify-between">
                <span x-text="file.fileName || 'Untitled'"></span>
                <a :href="file.fileUrl" class="underline text-primary" target="_blank">Download</a>
              </div>
            </template>
          </div>
        </template>

        <!-- FINANCIAL -->
        <template x-if="currentBid.tab === 'financial'">
          <div class="space-y-4">
            <h3 class="font-bold">Financial Documents</h3>
            <template x-for="file in (currentBid.financial?.files || [])" :key="file.fileUrl">
              <div class="p-3 bg-gray-100 rounded flex justify-between">
                <span x-text="file.fileName || 'Untitled'"></span>
                <a :href="file.fileUrl" class="underline text-primary" target="_blank">Download</a>
              </div>
            </template>

            <h3 class="font-bold">Quotation Documents</h3>
            <template x-for="file in (currentBid.quotes?.files || [])" :key="file.fileUrl">
              <div class="p-3 bg-gray-100 rounded flex justify-between">
                <span x-text="file.fileName || 'Untitled'"></span>
                <a :href="file.fileUrl" class="underline text-primary" target="_blank">Download</a>
              </div>
            </template>
          </div>
        </template>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
