<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="<%= csrfToken %>">
  <%- include("../partials/common/csrfInterceptor.ejs") %>
    <title>
      <%= title || "Verify OTP - NexaBid" %>
    </title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;600;700&display=swap" rel="stylesheet" />

    <style>
      body {
        font-family: 'Public Sans', sans-serif;
      }

      .otp-input {
        width: 48px;
        height: 56px;
        text-align: center;
        font-size: 20px;
      }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center px-4">
  <!-- Mobile Header with Hamburger -->
  <div class="w-full flex justify-between items-center py-4 md:hidden">
    <h1 class="text-xl font-bold text-gray-900">NexaBid</h1>
    <button id="menu-toggle" class="text-2xl text-gray-600">☰</button>
  </div>

  <!-- Mobile Dropdown -->
  <div id="mobile-menu" class="hidden md:hidden w-full bg-gray-200 p-4 text-center space-y-2">
    <a href="/" class="block text-gray-700 hover:text-primary">Home</a>
    <a href="/auth/login" class="block text-gray-700 hover:text-primary">Login</a>
    <a href="/auth/signup" class="block text-gray-700 hover:text-primary">Sign up</a>
  </div>

  <!-- OTP Card -->
  <div class="bg-white shadow-md rounded-xl p-6 w-full max-w-md text-center">
    <h2 class="text-2xl font-bold text-gray-900 mb-2">Enter the Code</h2>
    <p class="text-gray-700 text-sm mb-6">We sent a 6-digit code to your email.</p>

    <!-- OTP Form -->
    <form id="otpForm" class="space-y-6" method="post">
      <input type="hidden" id="userIdHidden" value="<%= userId %>" />
      <div class="flex justify-center gap-3">
        <% for(let i=1; i <=6; i++) { %>
          <input id="otp<%= i %>" maxlength="1" type="text"
            class="otp-input border-b-2 border-gray-400 focus:border-blue-600 outline-none" />
          <% } %>
      </div>

      <p id="otp-timer" class="text-red-500 font-semibold">00:59</p>
      <button id="resendOtpBtn" class="hidden text-blue-600 underline">Resend OTP</button>
      <button id="verifyBtn" type="submit"
        class="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">
        Verify
      </button>
    </form>
  </div>

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // Hamburger toggle
    document.getElementById('menu-toggle').addEventListener('click', () => {
      document.getElementById('mobile-menu').classList.toggle('hidden');
    });

    // OTP auto-focus
    const inputs = document.querySelectorAll('.otp-input');
    inputs.forEach((input, idx) => {
      input.addEventListener('input', () => {
        if (input.value.length === 1 && idx < inputs.length - 1) {
          inputs[idx + 1].focus();
        }
      });
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !input.value && idx > 0) {
          inputs[idx - 1].focus();
        }
      });
    });

    // --- Persistent Timer Logic ---
    const TIMER_DURATION = 50; // seconds
    const STORAGE_KEY = `otp_deadline_<%= userId %>`; // unique key per user
    const timerElement = document.getElementById('otp-timer');
    const verifyBtn = document.getElementById('verifyBtn');
    const resendBtn = document.getElementById('resendOtpBtn');

    let countdownInterval;

    function startTimer() {
      // Check for existing deadline
      let deadline = localStorage.getItem(STORAGE_KEY);
      const now = Date.now();

      if (!deadline) {
        // First visit or cleared data -> Start new timer
        deadline = now + (TIMER_DURATION * 1000);
        localStorage.setItem(STORAGE_KEY, deadline);
      } else {
        deadline = parseInt(deadline);
      }

      updateTimerDisplay(deadline); // Initial call

      // Clear any existing interval
      if (countdownInterval) clearInterval(countdownInterval);

      // Only start interval if not already expired
      if (deadline > now) {
        countdownInterval = setInterval(() => {
          updateTimerDisplay(deadline);
        }, 1000);
      }
    }

    function updateTimerDisplay(deadline) {
      const now = Date.now();
      const diff = Math.ceil((deadline - now) / 1000);

      if (diff <= 0) {
        // Time expired
        clearInterval(countdownInterval);
        // Do NOT clear localStorage here, or reload will restart timer!

        timerElement.textContent = 'OTP Expired ❌';
        verifyBtn.disabled = true;
        resendBtn.classList.remove('hidden');
      } else {
        // Ongoing
        let minutes = Math.floor(diff / 60);
        let seconds = diff % 60;
        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        // Ensure UI state matches active timer
        verifyBtn.disabled = false;
        resendBtn.classList.add('hidden');
      }
    }

    // Initialize timer on load
    startTimer();

    // Reset timer function (called after successful resend)
    function restartTimer() {
      const now = Date.now();
      const newDeadline = now + (TIMER_DURATION * 1000);
      localStorage.setItem(STORAGE_KEY, newDeadline);
      startTimer();
    }

    // Submit OTP
    document.getElementById('otpForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const otp = Array.from(inputs)
        .map((i) => i.value)
        .join('');

      if (otp.length !== 6) {
        return Swal.fire('Invalid OTP', 'Please enter 6 digits', 'error');
      }

      const route = '<%= mode %>' === 'forgot' ? '/auth/forgot-otp' : '/auth/verify-otp';
      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

      const res = await fetch(route, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ userId: '<%= userId %>', otp }),
      });

      const data = await res.json();

      if (!data.success) {
        return Swal.fire('Error', data.message, 'error');
      }

      // Clear timer storage on success
      localStorage.removeItem(STORAGE_KEY);

      Swal.fire('Verified!', 'Redirecting...', 'success');

      setTimeout(() => {
        if ('<%= mode %>' === 'forgot') {
          // Forgot password flow → go to reset password
          window.location.replace(`/auth/reset-password?userId=<%= userId %>&mode=forgot`);
        } else {
          // Signup flow → go directly to dashboard
          window.location.href = '/auth/dashboard';
        }
      }, 1500);
    });

    resendBtn.addEventListener('click', async (e) => {
      e.preventDefault();

      const userId = document.getElementById('userIdHidden').value;
      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

      verifyBtn.disabled = true;

      try {
        const res = await fetch('/auth/resend-otp', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ userId }),
        });

        const data = await res.json();

        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'New OTP Sent',
            text: 'Your new OTP has been sent to your email',
          });

          restartTimer();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Failed',
            text: data.message,
          });
          verifyBtn.disabled = false; // Re-enable if failed
        }
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Something went wrong. Please try again.',
        });
        verifyBtn.disabled = false;
      }
    });
  </script>
</body>

</html>