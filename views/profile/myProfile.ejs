<div class="max-w-4xl mx-auto px-6 py-10">

  <!-- Back Button + Title -->
  <div class="flex items-center gap-4 mb-10">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" 
      rel="stylesheet" />
    <button onclick="window.location.href='/user/profile'"
      class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition">
      <span class="material-symbols-outlined text-3xl">arrow_back</span>
    </button>

    <h1 class="text-3xl font-bold">My Profile</h1>
  </div>

 <!-- Profile Edit Form -->
<form id="profileForm" 
      action="/user/update-profile" 
      method="POST"
      enctype="multipart/form-data"
      class="space-y-6">

  <!-- Profile Image -->
    <!-- Profile Image -->
  <div class="flex flex-col items-center mb-8">
    <!-- preview img must have an id -->
    <img id="avatarPreview"
         src="<%= user && user.avatar ? user.avatar : 'https://via.placeholder.com/150' %>"
         class="w-28 h-28 rounded-full object-cover border-4 border-gray-200 shadow-sm mb-4"
         onerror="this.src='https://via.placeholder.com/150'">

    <!-- label points to the input using for="" so click opens file picker -->
    <label for="avatarUpload" class="cursor-pointer text-primary font-medium hover:underline">
      Change Photo
    </label>

    <!-- file input stays inside the same form and is hidden -->
    <input type="file" name="avatar" id="avatarUpload" accept="image/*" class="hidden" />
  </div>
 <input type="hidden" name="userId" value="<%= user && user._id ? user._id : '' %>">

  <!-- Full Name -->
  <div>
    <label class="block font-medium mb-1">Full Name</label>
    <input type="text" name="name"
      value="<%= user?.name || '' %>"
      class="w-full px-4 py-3 border rounded-lg focus:ring-primary focus:outline-none">
  </div>

  <!-- Email -->
  <div>
    <label class="block font-medium mb-1">Email</label>
    <input type="email" value="<%= user?.email || '' %>" disabled
      class="w-full px-4 py-3 border rounded-lg bg-gray-100 text-gray-500">
  </div>

  <!-- Phone -->
  <% if (user?.phone) { %>
    <div>
      <label class="block font-medium mb-1">Phone Number</label>
      <input type="text" name="phone" value="<%= user.phone %>"
        class="w-full px-4 py-3 border rounded-lg focus:ring-primary focus:outline-none">
    </div>
  <% } else { %>
    <div class="p-4 bg-yellow-100 border border-yellow-300 rounded-lg text-yellow-800">
      You logged in using Google. Phone number change is not available.
    </div>
  <% } %>

  <!-- Save Button -->
  <button type="submit"
    class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary/90 transition">
    Save Changes
  </button>

</form>
  <!-- CHANGE PASSWORD CARD -->
  <div class="bg-white rounded-2xl shadow p-8">

    <h2 class="text-2xl font-semibold mb-6">Change Password</h2>

    <% if (user && user.passwordHash) { %>

      <form id="passwordForm" action="/user/change-password" method="POST" class="space-y-6">

        <input type="hidden" name="userId" value="<%= user._id %>">

        <!-- Current Password -->
        <div>
          <label class="block font-medium mb-1">Current Password</label>
          <input type="password" name="currentPassword"
            class="w-full px-4 py-3 border rounded-lg focus:ring-primary focus:outline-none">
        </div>

        <!-- New Password -->
        <div>
          <label class="block font-medium mb-1">New Password</label>
          <input type="password" name="newPassword"
            class="w-full px-4 py-3 border rounded-lg focus:ring-primary focus:outline-none">
        </div>

        <!-- Confirm Password -->
        <div>
          <label class="block font-medium mb-1">Confirm New Password</label>
          <input type="password" name="confirmPassword"
            class="w-full px-4 py-3 border rounded-lg focus:ring-primary focus:outline-none">
        </div>

        <button type="submit"
          class="w-full bg-gray-900 text-white py-3 rounded-lg font-semibold hover:bg-black transition">
          Update Password
        </button>

      </form>

    <% } else { %>

      <div class="p-4 bg-yellow-100 border border-yellow-300 rounded-lg text-yellow-800">
        You logged in using Google.<br>
        Password change is not available.
      </div>

    <% } %>

  </div>
</div>

<!-- PASSWORD FORM JS -->
<script>
document.getElementById("passwordForm")?.addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = new FormData(e.target);
  const datas = new URLSearchParams(formData);

  Swal.fire({
    title: "Processing...",
    text: "Please wait",
    allowEscapeKey: false,
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading(),
  });

  const res = await fetch("/user/change-password", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: datas
  });

  const data = await res.json();
  Swal.close();

  if(data.success){
    Swal.fire({
      icon: "success",
      title: "Password Updated!",
      text: "Your password has been changed successfully.",
      timer: 2000,
      showConfirmButton: false
    });

    e.target.reset();
  } else {
    Swal.fire({
      icon: "error",
      title: "Error!",
      text: data.message || "Something went wrong"
    });
  }
});
</script>
<script>
document.getElementById("profileForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = new FormData(e.target);

  // Add avatar if selected
  const avatarFile = document.getElementById("avatarUpload").files[0];
  if (avatarFile) {
    formData.append("avatar", avatarFile);
  }

  Swal.fire({
    title: "Updating profile...",
    didOpen: () => Swal.showLoading(),
    allowOutsideClick: false,
  });

  const res = await fetch("/user/update-profile", {
    method: "POST",
    body: formData,
  });

  const data = await res.json();
  Swal.close();

  if (data.success) {
    Swal.fire({
      icon: "success",
      title: "Profile Updated!",
      text: data.message,
      timer: 2000,
      showConfirmButton: false,
    }).then(() => {
      location.reload();
    });
  } else {
    Swal.fire({
      icon: "error",
      title: "Error!",
      text: data.message,
    });
  }
});
</script>
<script>
/* -------------------------
  Avatar preview + client validation
   - Put this at the end of the page (after profileForm)
------------------------- */
(function () {
  const avatarInput = document.getElementById('avatarUpload');
  const avatarPreview = document.getElementById('avatarPreview');

  if (!avatarInput || !avatarPreview) return;

  avatarInput.addEventListener('change', (ev) => {
    const file = ev.target.files[0];
    if (!file) return;

    // basic validation
    const maxMB = 5;
    if (file.size > maxMB * 1024 * 1024) {
      Swal.fire({
        icon: 'error',
        title: 'File too large',
        text: `Please choose an image smaller than ${maxMB} MB.`,
      });
      avatarInput.value = "";
      return;
    }
    if (!file.type.startsWith('image/')) {
      Swal.fire({ icon: 'error', title: 'Invalid file', text: 'Please select an image file.' });
      avatarInput.value = "";
      return;
    }

    // show preview immediately
    const url = URL.createObjectURL(file);
    avatarPreview.src = url;
    avatarPreview.onload = () => URL.revokeObjectURL(url);
  });

  // clickable label already uses for="avatarUpload", no extra JS needed.
})();
</script>