<div class="max-w-6xl mx-auto px-4 py-10">
  <style>
    .admin-message {
      white-space: normal;
      word-break: break-word;
      line-height: 1.5;
    }
  </style>
  <h1 class="text-3xl font-bold text-gray-900 mb-6">My Tender Submissions</h1>

  <a href="/user/status"
    class="inline-flex items-center gap-2 mb-6 px-4 py-2 rounded-lg bg-gray-100 border hover:bg-gray-200">
    <span class="material-symbols-outlined">arrow_back</span>
    Back
  </a>

  <% if (!tenders || tenders.length===0) { %>

    <p class="text-gray-600 mt-10 text-lg">
      You have not created any tenders yet.
    </p>

    <% } else { %>

      <div class="bg-white shadow-md rounded-lg divide-y">

        <% tenders.forEach(t=> { %>

          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-5">

            <!-- LEFT CONTENT -->
            <div class="space-y-1">

              <p class="text-xl font-semibold text-gray-900">
                <%= t.title %>
              </p>

              <p class="text-primary font-semibold text-lg">
                Department: <%= t.dept %>
              </p>

              <!-- Status Badge -->
              <% if (t.status==="published" ) { %>
                <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-semibold">
                  Published
                </span>
                <% } else if (t.status==="submitted" ) { %>
                  <span class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 text-xs font-semibold">
                    Pending Approval
                  </span>
                  <% } else if (t.status==="draft" ) { %>
                    <span class="px-3 py-1 rounded-full bg-gray-200 text-gray-700 text-xs font-semibold">
                      Draft
                    </span>
                    <% } else if (t.status==="closed" ) { %>
                      <span class="px-3 py-1 rounded-full bg-gray-300 text-gray-800 text-xs font-semibold">
                        Closed
                      </span>
                      <% } else if (t.status==="rejected" ) { %>
                        <span class="px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-semibold">
                          Rejected
                        </span>
                        <% } else if (t.status==="awarded" ) { %>
                          <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-semibold">
                            Awarded
                          </span>
                          <% } %>

                            <% if (t.adminComment && t.adminComment.trim() !=="" ) { %>
                              </p>
                              <% } %>

                                <!-- FULL LIFECYCLE TRACKER -->
                                <div class="mt-8 mb-6 w-full px-4">
                                  <div class="flex items-center justify-between w-full relative">
                                    <div class="absolute w-full h-0.5 bg-gray-200 top-4 z-0"></div>

                                    <% const steps=[ { key: 'draft' , label: 'Draft' }, { key: 'submitted' ,
                                      label: 'Review' }, { key: 'published' , label: 'Published' }, { key: 'closed' ,
                                      label: 'Closed' }, { key: 'awarded' , label: 'Awarded' } ]; let
                                      currentStepIndex=-1; if (t.status==='draft' ) currentStepIndex=0; if
                                      (t.status==='submitted' ) currentStepIndex=1; if (t.status==='published' )
                                      currentStepIndex=2; if (t.status==='closed' ) currentStepIndex=3; if
                                      (t.status==='awarded' ) currentStepIndex=4; if (t.status==='rejected' )
                                      currentStepIndex=1; steps.forEach((step, index)=> {
                                      let circleClass = "bg-gray-100 text-gray-400 border-2 border-gray-300";
                                      if (index <= currentStepIndex) {
                                        circleClass="bg-green-500 text-white border-green-500" ; if
                                        (t.status==='rejected' && index===currentStepIndex) {
                                        circleClass="bg-red-500 text-white border-red-500" ; } } %>
                                        <div class="z-10 flex flex-col items-center flex-1">
                                          <div
                                            class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm <%= circleClass %> bg-white transition-all transform hover:scale-110">
                                            <% if (t.status==='rejected' && index===currentStepIndex) { %>
                                              ✕
                                              <% } else if (index < currentStepIndex || (index===currentStepIndex &&
                                                t.status !=='rejected' )) { %>
                                                ✓
                                                <% } else { %>
                                                  <%= index + 1 %>
                                                    <% } %>
                                          </div>
                                          <span
                                            class="text-xs font-semibold mt-2 text-center <%= index <= currentStepIndex ? 'text-gray-800' : 'text-gray-400' %>">
                                            <%= step.label %>
                                          </span>
                                        </div>
                                        <% }) %>
                                  </div>
                                </div>

            </div> <!-- End Left Content -->

            <!-- ACTIONS -->
            <div class="flex flex-col sm:flex-row gap-3 mt-4 sm:mt-0">

              <!-- VIEW DETAILS -->
              <a href="/tenders/<%= t._id %>"
                class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-800 font-semibold text-sm">
                View Details
              </a>

              <!-- EDIT: only draft & rejected -->
              <% if (t.status==="draft" || t.status==="rejected" ) { %>
                <a href="/user/manage/tenders/resubmit/<%= t._id %>"
                  class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold text-sm">
                  Edit Tender
                </a>
                <% } %>

                  <!-- RE-SUBMIT button only when rejected -->
                  <% if (t.status==="rejected" ) { %>
                    <a href="/user/manage/tenders/resubmit/<%= t._id %>"
                      class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm">
                      Re-submit
                    </a>
                    <% } %>

                      <!-- DELETE -->
                      <% if (t.status==="draft" || t.status==="rejected" ) { %>
                        <button onclick="deleteTender('<%= t._id %>')"
                          class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm">
                          Delete
                        </button>
                        <% } %>


            </div>

          </div>

          <% }) %>

      </div>

      <% } %>

</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  async function deleteTender(tenderId) {
    const confirm = await Swal.fire({
      title: "Are you sure?",
      text: "This tender will be deleted permanently.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, Delete"
    });

    if (!confirm.isConfirmed) return;

    try {
      const res = await fetch(`/user/manage/tenders/delete/${tenderId}`, {
        method: "DELETE",
        headers: { "Accept": "application/json" }
      });

      const data = await res.json();

      if (!data.success) {
        return Swal.fire({
          icon: "error",
          title: "Failed",
          text: data.message || "Could not delete tender"
        });
      }

      Swal.fire({
        icon: "success",
        title: "Deleted!",
        text: data.message || "Tender deleted successfully",
        timer: 1200,
        showConfirmButton: false
      });

      setTimeout(() => window.location.reload(), 1200);

    } catch (error) {
      console.error(error);
      Swal.fire({
        icon: "error",
        title: "Error",
        text: "Server error occurred"
      });
    }
  }
</script>