<body class="bg-background-light min-h-screen">

<!-- AUCTION STATUS BANNER -->
<% if (auctionStatus === 'not_started') { %>
  <div class="bg-yellow-100 text-yellow-800 text-center py-3 font-bold">
    ‚è≥ Auction has not started yet
  </div>
<% } else if (auctionStatus === 'ended') { %>
  <div class="bg-gray-200 text-gray-700 text-center py-3 font-bold">
    üèÅ Auction Ended
  </div>
<% } %>

<!-- HEADER -->
<div class="max-w-7xl mx-auto p-6">
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold">
        Live Auction Management: <%= property.title %>
      </h1>
      <p class="text-sm text-gray-500">
        Auction ID: <%= property._id %>
      </p>
    </div>

    <% if (auctionStatus === 'live') { %>
      <span class="bg-red-500 text-white px-3 py-1 rounded-full text-sm font-bold animate-pulse">
        LIVE
      </span>
    <% } %>
  </div>
</div>

<!-- COUNTDOWN -->
<% if (auctionStatus === 'live') { %>
<div class="max-w-7xl mx-auto p-6">
  <div class="bg-white border rounded-xl p-6 text-center">
    <p class="text-sm text-gray-500 mb-2">Time Remaining</p>
    <p id="countdown" class="text-3xl font-black text-primary">-- : -- : --</p>
  </div>
</div>
<% } %>

<!-- STATS -->
<div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 p-6">
  <div class="bg-primary text-white p-6 rounded-xl">
    <p class="text-sm">Current Highest Bid</p>
    <p class="text-3xl font-black">
      ‚Çπ <%= currentHighestBid.toLocaleString('en-IN') %>
    </p>
  </div>

  <div class="bg-white p-6 rounded-xl border">
    <p class="text-sm text-gray-500">Total Bids</p>
    <p class="text-3xl font-bold"><%= bids.length %></p>
  </div>

  <div class="bg-white p-6 rounded-xl border">
    <p class="text-sm text-gray-500">Highest Bidder</p>
    <p class="font-bold">
      <%= highestBidder ? highestBidder.name : '‚Äî' %>
    </p>
  </div>
</div>

<!-- MAIN GRID -->
<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">

<!-- BID FEED -->
<div class="lg:col-span-2 bg-white rounded-xl border overflow-hidden">
  <div class="p-4 border-b font-bold">Live Bid Feed</div>

  <table class="w-full text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-3 text-left">Bidder</th>
        <th class="p-3 text-left">Amount</th>
        <th class="p-3 text-left">Time</th>
      </tr>
    </thead>
    <tbody id="bidFeed">
      <% bids.forEach(bid => { %>
        <tr class="border-b">
          <td class="p-3"><%= bid.bidderId?.name || 'User' %></td>
          <td class="p-3 font-bold">‚Çπ <%= bid.amount.toLocaleString('en-IN') %></td>
          <td class="p-3 text-gray-500">
            <%= new Date(bid.createdAt).toLocaleTimeString() %>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<!-- RIGHT PANEL -->
<div class="space-y-6">

  <!-- WINNER -->
  <div class="bg-white p-6 rounded-xl border">
    <h3 class="font-bold mb-4">Winner Selection</h3>

    <% if (auctionStatus === 'ended' && highestBidder) { %>
      <p class="text-green-600 font-bold">
        üèÜ Winner: <%= highestBidder.name %>
      </p>
    <% } else { %>
      <p class="text-gray-500">
        Winner will be selected automatically after auction ends.
      </p>
    <% } %>
  </div>

  <!-- SYSTEM ALERTS -->
  <div class="bg-white p-6 rounded-xl border">
    <h3 class="font-bold mb-4">System Alerts</h3>
    <ul class="text-sm space-y-2">
      <% if (currentHighestBid >= property.auctionReservePrice) { %>
        <li class="text-green-600">‚úî Reserve price met</li>
      <% } else { %>
        <li class="text-yellow-600">‚ö† Reserve price not met</li>
      <% } %>
      <li class="text-gray-500">Live updates enabled</li>
    </ul>
  </div>

</div>
</div>

<!-- SOCKET -->
<script src="/socket.io/socket.io.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const socket = io();

    socket.on("connect", () => {
      console.log("‚úÖ Publisher socket connected");

      socket.emit("join_auction", {
        propertyId: "<%= property._id %>",
        userId: "<%= user._id %>"
      });
    });

    socket.on("new_bid", (data) => {
      console.log("üî• New bid received", data);

      const tbody = document.getElementById("bidFeed");
      if (!tbody) return;

      const tr = document.createElement("tr");
      tr.className = "border-b";

      tr.innerHTML = `
        <td class="p-3">${data.bidderId}</td>
        <td class="p-3 font-bold">‚Çπ ${data.amount.toLocaleString("en-IN")}</td>
        <td class="p-3 text-gray-500">
          ${new Date(data.time).toLocaleTimeString()}
        </td>
      `;

      tbody.prepend(tr);

      // Update highest bid card
      const highestBidEl = document.querySelector(".bg-primary .text-3xl");
      if (highestBidEl) {
        highestBidEl.innerText = "‚Çπ " + data.amount.toLocaleString("en-IN");
      }
    });
  });
</script>
<!-- COUNTDOWN SCRIPT -->
<% if (auctionStatus === 'live') { %>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const countdownEl = document.getElementById("countdown");
    const endTime = new Date("<%= auctionEndsAt %>").getTime();

    setInterval(() => {
      const diff = endTime - Date.now();

      if (diff <= 0) {
        countdownEl.innerText = "00 : 00 : 00";
        return;
      }

      const h = Math.floor(diff / 36e5);
      const m = Math.floor(diff / 6e4) % 60;
      const s = Math.floor(diff / 1e3) % 60;

      countdownEl.innerText =
        String(h).padStart(2, '0') + " : " +
        String(m).padStart(2, '0') + " : " +
        String(s).padStart(2, '0');
    }, 1000);
  });
</script>
<% } %>

</body>