<div class="relative flex h-auto min-h-screen w-full flex-col bg-gray-50 dark:bg-[#111921]">
  <!-- Main Content Area -->
  <div class="flex flex-1 justify-center py-8 px-4 md:px-10 lg:px-40">
    <div class="flex flex-col max-w-[960px] w-full gap-6">
      <!-- Breadcrumbs -->
      <div class="flex flex-wrap gap-2 text-sm">
        <a
          class="text-gray-600 dark:text-gray-400 hover:text-blue-600 transition-colors"
          href="/user/dashboard"
          >Dashboard</a
        >
        <span class="text-gray-400">/</span>
        <a
          class="text-gray-600 dark:text-gray-400 hover:text-blue-600 transition-colors"
          href="/user/tenders"
          >My Tenders</a
        >
        <span class="text-gray-400">/</span>
        <span class="text-gray-900 dark:text-white font-medium">Issue Work Order</span>
      </div>

      <!-- Page Heading -->
      <div>
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-2">
          Issue Work Order
        </h1>
        <p class="text-gray-600 dark:text-gray-400">
          Issue a work order to
          <strong class="text-gray-900 dark:text-white">
            <%= vendor?.name || 'the winning vendor' %>
          </strong>
          for tender
          <strong class="text-gray-900 dark:text-white"
            >#<%= tender?._id.toString().slice(-6) %>
          </strong>
        </p>
      </div>

      <!-- FORM -->
      <form
        id="workOrderForm"
        action="/publisher/tender/<%= tender._id %>/workorder"
        method="POST"
        enctype="multipart/form-data"
        class="flex flex-col gap-6 pb-20"
      >
        <!-- Section 1: Work Order Details -->
        <div
          class="bg-white dark:bg-[#1a222c] rounded-xl shadow-sm border border-gray-200 dark:border-gray-800"
        >
          <div class="border-b border-gray-200 dark:border-gray-800 px-6 py-4">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Work Order Details</h2>
          </div>
          <div class="p-6 space-y-6">
            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
                Work Order Title <span class="text-red-500">*</span>
              </label>
              <input
                name="title"
                required
                value="<%= tender?.title || '' %>"
                class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-[#1a222c] text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                placeholder="e.g. Roof Replacement Phase 1"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
                Description of Scope <span class="text-red-500">*</span>
              </label>
              <textarea
                name="description"
                required
                rows="5"
                class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-[#1a222c] text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-vertical transition-all"
                placeholder="Detailed description of the work to be performed..."
              >
<%= tender?.description || '' %></textarea
              >
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
                Contract Reference
              </label>
              <div
                class="flex items-center gap-3 px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800"
              >
                <span class="material-symbols-outlined text-gray-500 text-xl">badge</span>
                <span class="text-gray-900 dark:text-white font-semibold">
                  <%= contractRef %>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 2: Tender & Vendor Information -->
        <div
          class="bg-white dark:bg-[#1a222c] rounded-xl shadow-sm border border-gray-200 dark:border-gray-800"
        >
          <div class="border-b border-gray-200 dark:border-gray-800 px-6 py-4">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">
              Tender &amp; Vendor Information
            </h2>
          </div>
          <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
                Tender Reference
              </label>
              <div
                class="flex items-center gap-3 px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800"
              >
                <span class="material-symbols-outlined text-gray-500 text-xl">description</span>
                <span class="text-gray-900 dark:text-white font-medium"
                  >Tender #<%= tender?._id.toString().slice(-6) %>
                </span>
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
                Awarded Vendor
              </label>
              <div
                class="flex items-center gap-3 px-4 py-3 rounded-lg border border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20"
              >
                <span class="material-symbols-outlined text-green-600 text-xl">business</span>
                <span class="text-gray-900 dark:text-white font-semibold truncate">
                  <%= vendor?.name || 'N/A' %>
                </span>
              </div>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
                Vendor Contact
              </label>
              <div
                class="flex items-center gap-3 px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800"
              >
                <span class="material-symbols-outlined text-gray-500 text-xl">email</span>
                <span class="text-gray-600 dark:text-gray-400 truncate">
                  <%= vendor?.email || 'N/A' %>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 3: Timeline & Financials -->
        <div
          class="bg-white dark:bg-[#1a222c] rounded-xl shadow-sm border border-gray-200 dark:border-gray-800"
        >
          <div class="border-b border-gray-200 dark:border-gray-800 px-6 py-4">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">
              Timeline &amp; Financials
            </h2>
          </div>
          <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
                Start Date <span class="text-red-500">*</span>
              </label>
              <input
                name="startDate"
                required
                min="<%= new Date().toISOString().split('T')[0] %>"
                class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-[#1a222c] text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:[color-scheme:dark]"
                type="date"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
                Completion Date <span class="text-red-500">*</span>
              </label>
              <input
                name="completionDate"
                required
                min="<%= new Date().toISOString().split('T')[0] %>"
                class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-[#1a222c] text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:[color-scheme:dark]"
                type="date"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
                Work Order Value <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-semibold"
                  >â‚¹</span
                >
                <input
                  name="value"
                  required
                  min="0"
                  step="0.01"
                  value="<%= typeof amount !== 'undefined' ? amount : '' %>"
                  class="w-full pl-8 pr-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-[#1a222c] text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                  placeholder="0.00"
                  type="number"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Section 4: Milestones -->
        <div
          class="bg-white dark:bg-[#1a222c] rounded-xl shadow-sm border border-gray-200 dark:border-gray-800"
        >
          <div class="border-b border-gray-200 dark:border-gray-800 px-6 py-4">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">
              Milestones &amp; Deliverables
            </h2>
          </div>
          <div class="p-6">
            <div id="milestonesContainer" class="space-y-3 mb-4">
              <div class="milestone-row grid grid-cols-1 md:grid-cols-12 gap-3 items-center">
                <div class="md:col-span-7">
                  <input
                    name="milestones[0][description]"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-[#1a222c] text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                    placeholder="Milestone description"
                  />
                </div>
                <div class="md:col-span-4">
                  <input
                    name="milestones[0][dueDate]"
                    min="<%= new Date().toISOString().split('T')[0] %>"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-[#1a222c] text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm dark:[color-scheme:dark]"
                    type="date"
                  />
                </div>
                <div class="md:col-span-1 flex justify-center">
                  <button
                    type="button"
                    class="remove-milestone p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                  >
                    <span class="material-symbols-outlined text-xl">delete</span>
                  </button>
                </div>
              </div>
            </div>

            <button
              type="button"
              id="addMilestone"
              class="inline-flex items-center gap-2 px-4 py-2 text-blue-600 font-semibold text-sm hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors"
            >
              <span class="material-symbols-outlined text-xl">add</span>
              Add Milestone
            </button>
          </div>
        </div>

        <!-- Section 5: Attachments -->
        <div
          class="bg-white dark:bg-[#1a222c] rounded-xl shadow-sm border border-gray-200 dark:border-gray-800"
        >
          <div class="border-b border-gray-200 dark:border-gray-800 px-6 py-4">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Attachments</h2>
          </div>
          <div class="p-6">
            <label
              for="fileInput"
              class="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl p-8 flex flex-col items-center justify-center gap-4 bg-gray-50 dark:bg-gray-800/30 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors cursor-pointer group"
            >
              <div
                class="w-16 h-16 bg-blue-50 dark:bg-blue-900/30 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform"
              >
                <span class="material-symbols-outlined text-blue-600 text-3xl">cloud_upload</span>
              </div>
              <div class="text-center">
                <p class="text-gray-900 dark:text-white font-semibold">
                  Click to upload or drag and drop
                </p>
                <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">
                  PDF, DOCX, JPG or PNG (max. 10MB)
                </p>
              </div>
              <input type="file" id="fileInput" name="pdfFile" accept="application/pdf" required />
            </label>
            <div id="fileList" class="mt-4 space-y-2"></div>
          </div>
        </div>

        <!-- Hidden Fields -->
        <input type="hidden" name="tenderId" value="<%= tender._id %>" />
        <input type="hidden" name="vendorId" value="<%= vendor._id %>" />
        <input type="hidden" name="contractRef" value="<%= contractRef %>" />
      </form>
    </div>
  </div>

  <!-- Sticky Footer -->
  <div
    class="sticky bottom-0 w-full bg-white dark:bg-[#1a222c] border-t border-gray-200 dark:border-gray-800 py-4 px-6 shadow-lg z-10"
  >
    <div
      class="max-w-[960px] mx-auto flex flex-col sm:flex-row justify-end items-stretch sm:items-center gap-3"
    >
      <button
        type="button"
        onclick="window.history.back()"
        class="px-6 py-2.5 text-gray-600 dark:text-gray-400 font-semibold hover:text-gray-900 dark:hover:text-white transition-colors order-3 sm:order-1"
      >
        Cancel
      </button>
      <button
        type="button"
        id="saveDraftBtn"
        class="px-6 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white font-semibold bg-white dark:bg-transparent hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors order-2"
      >
        Save Draft
      </button>
      <button
        type="submit"
        form="workOrderForm"
        class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg inline-flex items-center justify-center gap-2 shadow-sm transition-colors order-1 sm:order-3"
      >
        <span class="material-symbols-outlined text-lg">send</span>
        Issue Work Order
      </button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  let milestoneCount = 1;
  const minDate = '<%= new Date().toISOString().split("T")[0] %>';

  document.getElementById('addMilestone')?.addEventListener('click', function () {
    const container = document.getElementById('milestonesContainer');
    const newRow = document.createElement('div');
    newRow.className = 'milestone-row grid grid-cols-1 md:grid-cols-12 gap-3 items-center';
    newRow.innerHTML = `
    <div class="md:col-span-7">
      <input 
        name="milestones[${milestoneCount}][description]"
        class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-[#1a222c] text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" 
        placeholder="Milestone description" 
      />
    </div>
    <div class="md:col-span-4">
      <input 
        name="milestones[${milestoneCount}][dueDate]"
        min="${minDate}"
        class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-[#1a222c] text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm dark:[color-scheme:dark]" 
        type="date"
      />
    </div>
    <div class="md:col-span-1 flex justify-center">
      <button type="button" class="remove-milestone p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
        <span class="material-symbols-outlined text-xl">delete</span>
      </button>
    </div>
  `;
    container.appendChild(newRow);
    milestoneCount++;
  });

  document.getElementById('milestonesContainer')?.addEventListener('click', function (e) {
    if (e.target.closest('.remove-milestone')) {
      const row = e.target.closest('.milestone-row');
      if (document.querySelectorAll('.milestone-row').length > 1) {
        row.remove();
      } else {
        Swal.fire('Warning', 'At least one milestone is required', 'warning');
      }
    }
  });

  document.getElementById('fileInput')?.addEventListener('change', function (e) {
    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '';
    Array.from(this.files).forEach((file, index) => {
      const fileItem = document.createElement('div');
      fileItem.className =
        'flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700';
      fileItem.innerHTML = `
      <div class="flex items-center gap-3 flex-1 min-w-0">
        <span class="material-symbols-outlined text-blue-600 text-xl">description</span>
        <span class="text-gray-900 dark:text-white text-sm truncate font-medium">${file.name}</span>
        <span class="text-gray-500 text-xs whitespace-nowrap">${(file.size / 1024).toFixed(1)} KB</span>
      </div>
      <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 p-1">
        <span class="material-symbols-outlined text-xl">close</span>
      </button>
    `;
      fileList.appendChild(fileItem);
    });
  });

  const startDate = document.querySelector('[name="startDate"]');
  const endDate = document.querySelector('[name="completionDate"]');
  startDate?.addEventListener('change', () => (endDate.min = startDate.value));
  endDate?.addEventListener('change', function () {
    if (this.value && startDate.value && this.value < startDate.value) {
      Swal.fire('Invalid Date', 'Completion date must be after start date', 'warning');
      this.value = '';
    }
  });
</script>
