<main class="flex w-full flex-1 justify-center py-8 px-4 sm:px-6 lg:px-8">
  <div class="flex flex-col w-full max-w-4xl gap-8">
    <h1 class="text-3xl font-black">Submit Financial Bid for: <%= tender.title %>
    </h1>

    <!-- IF ALREADY SUBMITTED -->
    <% if (bid && ( (bid.finForms && bid.finForms.files && bid.finForms.files.length> 0) ||
      (bid.quotes && bid.quotes.files && bid.quotes.files.length > 0) )) { %>
      <div class="bg-green-100 p-4 rounded-lg border border-green-300">
        <h2 class="font-bold text-green-800">âœ” Financial documents already submitted.</h2>
        <p class="text-green-700 text-sm mt-1">You cannot upload again.</p>
        <a href="/vendor/tenders" class="underline text-primary font-semibold mt-2 inline-block">Go Back</a>
      </div>

      <% } else { %>

        <!-- FINANCIAL FORM -->
        <form id="financialForm" action="/vendor/tender/uploads/<%= tender._id %>/financial" method="POST"
          enctype="multipart/form-data" class="space-y-10">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <!-- Amount -->
          <div class="p-6 rounded-xl border bg-white">
            <label class="font-bold text-lg">Quotation Amount (â‚¹)</label>
            <input type="number" name="amount" required class="w-full mt-3 border p-3 rounded-lg"
              placeholder="Enter quotation amount" />
          </div>

          <!-- Upload Inputs -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- FINANCIAL FORMS -->
            <div>
              <label for="finFiles"
                class="cursor-pointer flex flex-col items-center gap-4 border-2 border-dashed rounded-xl px-6 py-12 bg-white">
                <p class="text-lg font-bold">Financial Forms</p>
                <p class="text-sm text-slate-500">Click to select files</p>
              </label>

              <!-- MUST MATCH multer fields: name="finForms" -->
              <input type="file" id="finFiles" name="finForms" hidden multiple />
              <div id="finPreview" class="text-primary text-sm mt-3 font-medium"></div>
            </div>

            <!-- QUOTATION DOCUMENTS -->
            <div>
              <label for="quoteFiles"
                class="cursor-pointer flex flex-col items-center gap-4 border-2 border-dashed rounded-xl px-6 py-12 bg-white">
                <p class="text-lg font-bold">Quotation Documents</p>
                <p class="text-sm text-slate-500">Click to select files</p>
              </label>

              <!-- MUST MATCH multer fields: name="quotationFiles" -->
              <input type="file" id="quoteFiles" name="quotationFiles" hidden multiple />
              <div id="quotePreview" class="text-primary text-sm mt-3 font-medium"></div>
            </div>
          </div>

          <!-- Confirm -->
          <div class="p-6 rounded-xl border bg-white">
            <label class="flex items-center gap-x-3">
              <input id="confirmCheck" type="checkbox" class="w-5 h-5" />
              <p class="text-sm">I confirm all details are true.</p>
            </label>
          </div>

          <!-- Submit -->
          <div class="flex justify-end pt-4 border-t">
            <!-- button is type=button because we validate first in JS -->
            <button id="submitFinBidBtn" type="button" class="px-8 py-3 bg-primary text-white font-bold rounded-lg">
              Submit Financial Bid
            </button>
          </div>
        </form>

        <% } %>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // DOM refs
  const finInput = document.getElementById('finFiles');
  const quoteInput = document.getElementById('quoteFiles');
  const finPreview = document.getElementById('finPreview');
  const quotePreview = document.getElementById('quotePreview');
  const submitBtn = document.getElementById('submitFinBidBtn');
  const confirmCheck = document.getElementById('confirmCheck');
  const financialForm = document.getElementById('financialForm');

  // Preview handlers
  finInput?.addEventListener('change', (e) => {
    finPreview.innerHTML = [...e.target.files].map((f) => `ðŸ“„ ${f.name}`).join('<br>');
  });
  quoteInput?.addEventListener('change', (e) => {
    quotePreview.innerHTML = [...e.target.files].map((f) => `ðŸ“„ ${f.name}`).join('<br>');
  });

  // Submit validation + submit
  submitBtn.addEventListener('click', () => {
    if (!confirmCheck.checked) {
      return Swal.fire({
        icon: 'warning',
        title: 'Please Confirm',
        text: 'Tick confirmation checkbox.',
      });
    }

    const finCount = finInput?.files?.length || 0;
    const quoteCount = quoteInput?.files?.length || 0;

    if (finCount === 0) {
      return Swal.fire({
        icon: 'warning',
        title: 'Missing Financial Forms',
        text: 'Please upload financial forms.',
      });
    }
    if (quoteCount === 0) {
      return Swal.fire({
        icon: 'warning',
        title: 'Missing Quotation Docs',
        text: 'Please upload quotation documents.',
      });
    }

    // All good â†’ submit native form
    financialForm.submit();
  });

  // Show success alert when redirected with ?uploaded=true
  if (new URLSearchParams(location.search).get('uploaded') === 'true') {
    Swal.fire({
      icon: 'success',
      title: 'Financial Bid Submitted ðŸŽ‰',
      text: 'Your financial documents were uploaded successfully!',
    }).then(() => history.replaceState(null, '', location.pathname));
  }
</script>