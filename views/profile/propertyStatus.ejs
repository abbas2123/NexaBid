<div class="max-w-6xl mx-auto px-4 py-10">
  <h1 class="text-3xl font-bold text-gray-900 mb-6">My Property Submissions</h1>

  <a
    href="/user/status"
    class="inline-flex items-center gap-2 mb-6 px-4 py-2 rounded-lg bg-gray-100 border hover:bg-gray-200"
  >
    <span class="material-symbols-outlined">arrow_back</span>
    Back
  </a>

  <% if (!properties || properties.length===0) { %>
  <p class="text-gray-600 mt-10 text-lg">You have not submitted any properties yet.</p>

  <% } else { %>

  <div class="bg-white shadow-md rounded-lg divide-y">
    <% properties.forEach(p=> { %>

    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-5">
      <!-- LEFT CONTENT -->
      <div class="space-y-1">
        <p class="text-xl font-semibold text-gray-900"><%= p.title %></p>

        <p class="text-primary font-semibold text-lg">
          <% if (p.isAuction) { %> ₹ <%= p.basePrice?.toLocaleString() || '-' %> <% } else { %> ₹
          <%= p.buyNowPrice?.toLocaleString() || '-' %> <% } %>
        </p>

        <% if (p.verificationStatus==="approved" ) { %>
        <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-semibold">
          Approved
        </span>
        <% } else if (p.verificationStatus==="submitted" ) { %>
        <span class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 text-xs font-semibold">
          Submitted
        </span>
        <% } else { %>
        <span class="px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-semibold">
          Rejected
        </span>
        <% } %> <% if (p.rejectionMessage) { %>
        <p class="text-xs text-red-500 mt-2">
          <b>Reason:</b>
          <%= p.rejectionMessage %>
        </p>
        <% } %>
      </div>

      <!-- FULL LIFECYCLE TRACKER -->
      <div class="mt-4 mb-4 w-full px-2">
        <div class="flex items-center justify-between w-full relative">
          <div class="absolute w-full h-0.5 bg-gray-200 top-4 z-0"></div>
          <% const propSteps=[ { label: 'Review' }, { label: 'Approved' }, { label: 'Active' }, {
          label: 'Sold' } ]; let pIndex=0; if (p.verificationStatus==='submitted' ) pIndex=0; if
          (p.verificationStatus==='rejected' ) pIndex=0; if (p.verificationStatus==='approved' )
          pIndex=2; if (p.isSold) pIndex=3; propSteps.forEach((step, index)=> { let circleClass =
          "bg-gray-100 text-gray-400 border-2 border-gray-300"; if (index <= pIndex) {
          circleClass="bg-green-500 text-white border-green-500" ; if
          (p.verificationStatus==='rejected' && index===pIndex) { circleClass="bg-red-500 text-white
          border-red-500" ; } } %>
          <div class="z-10 flex flex-col items-center flex-1">
            <div
              class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm <%= circleClass %> bg-white"
            >
              <% if (p.verificationStatus==='rejected' && index===pIndex) { %> ✕ <% } else if (index
              < pIndex || (index===pIndex && p.verificationStatus !=='rejected' )) { %> ✓ <% } else
              { %> <%= index + 1 %> <% } %>
            </div>
            <span
              class="text-xs font-semibold mt-1 <%= index <= pIndex ? 'text-gray-800' : 'text-gray-400' %>"
            >
              <%= step.label %>
            </span>
          </div>
          <% }) %>
        </div>
      </div>

      <!-- ACTIONS -->
      <!-- ACTIONS -->
      <div class="flex flex-col sm:flex-row gap-3">
        <!-- VIEW DETAILS -->
        <a
          href="/properties/<%= p._id %>"
          class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-800 font-semibold text-sm"
        >
          View Details
        </a>

        <!-- EDIT BUTTON (Show always except rejected without form UPDATE) -->
        <a
          href="/user/status/propertyStatus/edit/<%= p._id %>"
          class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold text-sm"
        >
          Edit Property
        </a>

        <!-- RE-SUBMIT BUTTON (only when rejected) -->
        <% if (p.verificationStatus==="rejected" ) { %>
        <a
          href="/properties/create?id=<%= p._id %>"
          class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm"
        >
          Re-submit
        </a>
        <% } %>
        <!-- DELETE PROPERTY -->
        <form
          action="/user/status/property/delete/<%= p._id %>"
          method="POST"
          onsubmit="return confirmDelete(event);"
        >
          <button
            type="submit"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm"
          >
            Delete
          </button>
        </form>
      </div>
    </div>

    <% }) %>
  </div>

  <% } %>
</div>

<script>
  function confirmDelete(event) {
    event.preventDefault();

    Swal.fire({
      title: 'Are you sure?',
      text: 'This will permanently delete the property.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, delete it!',
    }).then((result) => {
      if (result.isConfirmed) {
        event.target.submit();
      }
    });

    return false;
  }
</script>
