<main class="py-16 sm:py-24">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto">
      <!-- USER HEADER -->
      <div class="text-center mb-12">
        <div class="relative inline-block group">
          <% if (user.avatar) { %>
            <img src="<%= user.avatar %>" id="userAvatar"
              class="w-24 h-24 rounded-full mx-auto object-cover border-4 border-white shadow-lg" />
            <% } else { %>
              <div id="userAvatarInitial"
                class="w-24 h-24 rounded-full mx-auto border-4 border-white shadow-lg flex items-center justify-center text-white text-4xl font-bold bg-gradient-to-br from-blue-500 to-indigo-600">
                <%= user.name ? user.name.charAt(0).toUpperCase() : 'U' %>
              </div>
              <% } %>

                <!-- UPLOAD OVERLAY -->
                <button onclick="document.getElementById('avatarInput').click()"
                  class="absolute bottom-0 right-0 bg-blue-600 text-white p-2 rounded-full border-2 border-white hover:bg-blue-700 transition-all shadow-md group-hover:scale-110"
                  title="Change Profile Picture">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                </button>

                <input type="file" id="avatarInput" class="hidden" accept="image/*"
                  onchange="handleAvatarUpload(this)" />
        </div>

        <h1 class="text-3xl sm:text-4xl font-bold mt-4">
          <%= user.name %>
        </h1>

        <p class="text-gray-500">
          <%= user.email %>
        </p>

        <!-- ROLE BADGE -->
        <span
          class="inline-block mt-3 px-3 py-1 rounded-full text-white <%= user.role === 'vendor' ? 'bg-green-600' : 'bg-gray-700' %>">
          <%= (user && user.role) ? user.role.toUpperCase() : "USER" %>
        </span>
      </div>

      <!-- ACCOUNT NAVIGATION BUTTONS -->
      <div class="space-y-3 mb-12">
        <a class="block text-center font-medium bg-gray-100 hover:bg-gray-200 py-4 rounded-lg transition-colors"
          href="/user/my-listings">My Listings</a>

        <a class="block text-center font-medium bg-gray-100 hover:bg-gray-200 py-4 rounded-lg transition-colors"
          href="/user/my-participation">My Participation</a>

        <a class="block text-center font-medium bg-gray-100 hover:bg-gray-200 py-4 rounded-lg transition-colors"
          href="/user/my-profile">My Profile</a>

        <a class="block text-center font-medium bg-gray-100 hover:bg-gray-200 py-4 rounded-lg transition-colors"
          href="/user/transactions">Transaction History</a>

        <!-- <a
          class="block text-center font-medium bg-gray-100 hover:bg-gray-200 py-4 rounded-lg transition-colors"
          href="/user/tender-reports"
          >Tender-Report</a
        > -->

        <a class="block text-center font-medium bg-gray-100 hover:bg-gray-200 py-4 rounded-lg transition-colors"
          href="/user/report-management">Report Management</a>

        <a class="block text-center font-medium bg-gray-100 hover:bg-gray-200 py-4 rounded-lg transition-colors"
          href="/user/status">Status</a>

        <a class="block text-center font-medium bg-gray-100 hover:bg-gray-200 py-4 rounded-lg transition-colors"
          href="/wallet">Wallet</a>

        <a class="block text-center font-medium bg-gray-100 hover:bg-gray-200 py-4 rounded-lg transition-colors"
          href="/user/about-us">About Us</a>

        <button onclick="confirmLogout()"
          class="block text-center font-medium bg-red-500 text-white w-full py-4 rounded-lg hover:bg-red-600 transition-colors">
          Logout
        </button>
      </div>

      <!-- ============================= -->
      <!-- VENDOR VERIFICATION STATUS -->
      <!-- ============================= -->

      <a href="/user/status" class="block bg-white border rounded-xl p-6 shadow-sm hover:shadow-md transition"
        style="text-decoration: none; color: inherit">
        <h2 class="text-2xl font-semibold mb-4">Vendor Verification Status</h2>

        <% if (!application) { %>

          <p class="text-gray-600 mb-4">You have not applied for vendor verification.</p>

          <div class="px-4 py-3 rounded-lg bg-primary text-white font-medium hover:bg-primary/90 text-center">
            Apply Now
          </div>

          <% } else { %>

            <!-- STATUS BADGE -->
            <p class="mb-3">
              <b>Status:</b>
              <span
                class="px-3 py-1 rounded text-white <%= application.status === 'approved' ? 'bg-green-600' : application.status === 'pending' ? 'bg-yellow-500' : application.status === 'submitted' ? 'bg-blue-600' : 'bg-red-600' %>">
                <%= application.status.toUpperCase() %>
              </span>
            </p>

            <% if (application.adminNote) { %>
              <p class="mb-3">
                <b>Admin Note:</b>
                <%= application.adminNote %>
              </p>
              <% } %>

                <p class="mb-3">
                  <b>Last Updated:</b>
                  <%= application.updatedAt.toDateString() %>
                </p>

                <div class="mt-6">
                  <% if (application.status==="rejected" ) { %>
                    <div class="px-4 py-3 bg-red-600 text-white rounded-lg text-center">Reapply</div>
                    <% } %>
                      <% if (application.status==="approved" ) { %>
                        <div class="px-4 py-3 bg-green-100 text-green-700 rounded-lg text-center font-semibold">
                          âœ” You are a Verified Vendor!
                        </div>
                        <% } %>
                          <% if (application.status==="pending" || application.status==="submitted" ) { %>
                            <div class="px-4 py-3 bg-yellow-100 text-yellow-700 rounded-lg text-center font-semibold">
                              Your application is under review
                            </div>
                            <% } %>
                </div>

                <% } %>
      </a>
    </div>
  </div>
</main>
<script>
  async function handleAvatarUpload(input) {
    if (!input.files || !input.files[0]) return;



    const file = input.files[0];
    const fileName = file.name;
    const extension = fileName.split('.').pop().toLowerCase();
    let allowed = ['jpg', 'png'];

    if (!allowed.includes(extension)) {
      Swal.fire({
        title: 'Not allowed',
        text: 'File type is not allowed',
        icon: 'error'
      });
      return;
    }
    const formData = new FormData();
    formData.append('avatar', file);

    try {
      Swal.fire({
        title: 'Uploading...',
        text: 'Please wait while we update your profile picture',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      const response = await fetch('/user/profile/avatar', {
        method: 'PATCH',
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: 'Profile picture updated successfully',
          timer: 1500,
          showConfirmButton: false
        }).then(() => {
          window.location.reload();
        });
      } else {
        throw new Error(data.message || 'Upload failed');
      }
    } catch (error) {
      console.error('Avatar Upload Error:', error);
      Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: error.message || 'Something went wrong while uploading'
      });
    }
  }

  function confirmLogout() {
    console.log('logout');
    Swal.fire({
      title: 'Logout?',
      text: 'Are you sure you want to log out?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, Logout',
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = '/user/logout';
      }
    });
  }
</script>