<body class="bg-background-light min-h-screen">

<!-- AUCTION STATUS BANNER -->
<% if (auctionStatus === 'not_started') { %>
  <div class="bg-yellow-100 text-yellow-800 text-center py-3 font-bold">
    ‚è≥ Auction has not started yet
  </div>
<% } else if (auctionStatus === 'ended') { %>
  <div class="bg-gray-200 text-gray-700 text-center py-3 font-bold">
    üèÅ Auction Ended
  </div>
<% } %>

<!-- HEADER -->
<div class="max-w-7xl mx-auto p-6">
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold">
        Live Auction Management: <%= property.title %>
      </h1>
      <p class="text-sm text-gray-500">
        Auction ID: <%= property._id %>
      </p>
    </div>

    <% if (auctionStatus === 'live') { %>
      <span class="bg-red-500 text-white px-3 py-1 rounded-full text-sm font-bold animate-pulse">
        LIVE
      </span>
    <% } %>
  </div>
</div>

<!-- COUNTDOWN -->
<% if (auctionStatus === 'live') { %>
<div class="max-w-7xl mx-auto p-6">
  <div class="bg-white border rounded-xl p-6 text-center">
    <p class="text-sm text-gray-500 mb-2">Time Remaining</p>
    <p id="countdown" class="text-3xl font-black text-primary">-- : -- : --</p>
  </div>
</div>
<% } %>

<!-- STATS -->
<div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 p-6">
  <div class="bg-primary text-white p-6 rounded-xl">
    <p class="text-sm">Current Highest Bid</p>
    <p id="currentHighestBid" class="text-3xl font-black">
      ‚Çπ <%= currentHighestBid.toLocaleString('en-IN') %>
    </p>
  </div>

  <div class="bg-white p-6 rounded-xl border">
    <p class="text-sm text-gray-500">Total Bids</p>
    <p id="totalBids" class="text-3xl font-bold"><%= bids.length %></p>
  </div>

  <div class="bg-white p-6 rounded-xl border">
    <p class="text-sm text-gray-500">Highest Bidder</p>
    <p id="highestBidderName" class="font-bold">
      <%= highestBidder ? highestBidder.name : '‚Äî' %>
    </p>
  </div>
</div>

<!-- MAIN GRID -->
<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">

<!-- BID FEED -->
<div class="lg:col-span-2 bg-white rounded-xl border overflow-hidden">
  <div class="p-4 border-b font-bold">Live Bid Feed</div>

  <div class="max-h-[500px] overflow-y-auto">
    <table class="w-full text-sm">
      <thead class="bg-gray-100 sticky top-0">
        <tr>
          <th class="p-3 text-left">Bidder</th>
          <th class="p-3 text-left">Amount</th>
          <th class="p-3 text-left">Time</th>
          <th class="p-3 text-left">Type</th>
        </tr>
      </thead>
      <tbody id="bidFeed">
        <% bids.forEach(bid => { %>
          <tr class="border-b hover:bg-gray-50">
            <td class="p-3"><%= bid.bidderId?.name || 'User' %></td>
            <td class="p-3 font-bold">‚Çπ <%= bid.amount.toLocaleString('en-IN') %></td>
            <td class="p-3 text-gray-500">
              <%= new Date(bid.createdAt).toLocaleTimeString() %>
            </td>
            <td class="p-3">
              <% if (bid.isAutoBid) { %>
                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">Auto</span>
              <% } else { %>
                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Manual</span>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<!-- RIGHT PANEL -->
<div class="space-y-6">

  <!-- WINNER -->
  <div class="bg-white p-6 rounded-xl border">
    <h3 class="font-bold mb-4">Winner Selection</h3>

    <% if (auctionStatus === 'ended' && highestBidder) { %>
      <p class="text-green-600 font-bold">
        üèÜ Winner: <%= highestBidder.name %>
      </p>
    <% } else { %>
      <p class="text-gray-500">
        Winner will be selected automatically after auction ends.
      </p>
    <% } %>
  </div>

  <!-- SYSTEM ALERTS -->
  <div class="bg-white p-6 rounded-xl border">
    <h3 class="font-bold mb-4">System Alerts</h3>
    <ul class="text-sm space-y-2">
      <% if (property.auctionReservePrice && currentHighestBid >= property.auctionReservePrice) { %>
        <li class="text-green-600">‚úî Reserve price met</li>
      <% } else if (property.auctionReservePrice) { %>
        <li class="text-yellow-600">‚ö† Reserve price not met</li>
      <% } %>
      <li class="text-gray-500" id="connectionStatus">üî¥ Connecting...</li>
    </ul>
  </div>

  <!-- AUCTION STATS -->
  <div class="bg-white p-6 rounded-xl border">
    <h3 class="font-bold mb-4">Auction Details</h3>
    <div class="text-sm space-y-2">
      <div class="flex justify-between">
        <span class="text-gray-500">Base Price:</span>
        <span class="font-bold">‚Çπ <%= property.basePrice.toLocaleString('en-IN') %></span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-500">Bid Step:</span>
        <span class="font-bold">‚Çπ <%= property.auctionStep.toLocaleString('en-IN') %></span>
      </div>
      <% if (property.auctionReservePrice) { %>
      <div class="flex justify-between">
        <span class="text-gray-500">Reserve Price:</span>
        <span class="font-bold">‚Çπ <%= property.auctionReservePrice.toLocaleString('en-IN') %></span>
      </div>
      <% } %>
    </div>
  </div>

</div>
</div>

<!-- Notification Container -->
<div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- SOCKET SCRIPT -->
<script src="/socket.io/socket.io.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
  const socket = io("http://localhost:3000", {
  withCredentials: true
});
    const propertyId = "<%= property._id %>";
    const userId = "<%= user._id %>";

    // Connection status
    socket.on("connect", () => {
      console.log("‚úÖ Publisher socket connected");
      
      const statusEl = document.getElementById("connectionStatus");
      if (statusEl) {
        statusEl.innerHTML = 'üü¢ Connected';
        statusEl.className = 'text-green-600';
      }

      socket.emit("join_auction", { propertyId, userId });
      socket.emit("join", userId);
    });

    socket.on("disconnect", () => {
      console.log("‚ùå Socket disconnected");
      const statusEl = document.getElementById("connectionStatus");
      if (statusEl) {
        statusEl.innerHTML = 'üî¥ Disconnected';
        statusEl.className = 'text-red-600';
      }
    });

    // New bid received
    socket.on("new_bid", (data) => {
      console.log("üî• New bid received", data);

      const tbody = document.getElementById("bidFeed");
      if (!tbody) return;

      const tr = document.createElement("tr");
      tr.className = "border-b hover:bg-gray-50 animate-fadeIn";

      tr.innerHTML = `
       <td class="p-3">${data.bidderName || 'User'}</td>
        <td class="p-3 font-bold text-green-600">‚Çπ ${data.amount.toLocaleString("en-IN")}</td>
        <td class="p-3 text-gray-500">
          ${new Date(data.time).toLocaleTimeString()}
        </td>
        <td class="p-3">
          ${data.isAutoBid 
            ? '<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">Auto</span>' 
            : '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Manual</span>'
          }
        </td>
      `;

      tbody.prepend(tr);

      // Update highest bid card
      const highestBidEl = document.getElementById("currentHighestBid");
      if (highestBidEl) {
        highestBidEl.innerHTML = "‚Çπ " + data.amount.toLocaleString("en-IN");
        highestBidEl.classList.add('animate-pulse');
        setTimeout(() => highestBidEl.classList.remove('animate-pulse'), 1000);
      }

      // Update total bids count
      const totalBidsEl = document.getElementById("totalBids");
      if (totalBidsEl) {
        const currentCount = parseInt(totalBidsEl.textContent);
        totalBidsEl.textContent = currentCount + 1;
      }

      // Show notification
      showNotification('New Bid!', `‚Çπ${data.amount.toLocaleString("en-IN")}`, 'info');
    });

    // ‚úÖ Auction extended event
    socket.on("auction_extended", (data) => {
      console.log("‚è∞ Auction extended:", data);

      const newEndTime = new Date(data.newEndTime);

      // Update global variable
      if (window.updateCountdown) {
        window.auctionEndsAt = newEndTime;
        updateCountdown();
      }

      // Show notification
      showNotification(
        'Auction Extended!',
        `Added ${data.extendedBy} minutes to the auction`,
        'warning'
      );
    });

    // Auction ended event
    socket.on("auction_ended", (data) => {
      console.log("üèÅ Auction ended:", data);

      showNotification('Auction Ended!', 'Processing results...', 'success');

      setTimeout(() => {
        window.location.reload();
      }, 3000);
    });

    // Notification function
    function showNotification(title, message, type) {
      const colors = {
        info: 'bg-blue-500',
        warning: 'bg-yellow-500',
        success: 'bg-green-500',
        error: 'bg-red-500'
      };

      const notification = document.createElement('div');
      notification.className = `${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg animate-slideIn`;
      notification.innerHTML = `
        <div class="flex items-center gap-3">
          <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <p class="font-bold">${title}</p>
            <p class="text-sm">${message}</p>
          </div>
        </div>
      `;

      const container = document.getElementById('notificationContainer');
      container.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 5000);
    }
  });
</script>

<!-- COUNTDOWN SCRIPT -->
<% if (auctionStatus === 'live') { %>
<script>
  // ‚úÖ Global variables for countdown
  let countdownInterval;
  window.auctionEndsAt = new Date("<%= auctionEndsAt %>");

  function updateCountdown() {
    // Clear existing interval
    if (countdownInterval) {
      clearInterval(countdownInterval);
    }

    const countdownEl = document.getElementById("countdown");
    
    if (!countdownEl) return;

    countdownInterval = setInterval(() => {
      const now = Date.now();
      const endTime = window.auctionEndsAt.getTime();
      const diff = endTime - now;

      if (diff <= 0) {
        clearInterval(countdownInterval);
        countdownEl.innerHTML = '<span class="text-red-600">00 : 00 : 00</span>';
        countdownEl.classList.add('animate-pulse');
        return;
      }

      const h = Math.floor(diff / 36e5);
      const m = Math.floor(diff / 6e4) % 60;
      const s = Math.floor(diff / 1e3) % 60;

      // Last minute warning
      const className = diff < 60000 ? 'text-red-600 animate-pulse' : 'text-primary';

      countdownEl.innerHTML = `
        <span class="${className}">
          ${String(h).padStart(2, '0')} : ${String(m).padStart(2, '0')} : ${String(s).padStart(2, '0')}
        </span>
      `;
    }, 1000);
  }

  // Start countdown on page load
  document.addEventListener("DOMContentLoaded", () => {
    updateCountdown();
  });
</script>
<% } %>

<!-- ANIMATION STYLES -->
<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  .animate-fadeIn {
    animation: fadeIn 0.3s ease-in-out;
  }

  .animate-slideIn {
    animation: slideIn 0.3s ease-out;
  }

  /* Smooth scrolling for bid feed */
  #bidFeed {
    scroll-behavior: smooth;
  }

  /* Pulse animation for updates */
  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
  }

  .animate-pulse {
    animation: pulse 1s ease-in-out;
  }
</style>

</body>
