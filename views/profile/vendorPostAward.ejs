<h2 class="text-xl font-bold mb-3">Purchase Order</h2>

<% if (!po) { %>

<!-- PO NOT CREATED -->
<div class="p-4 bg-yellow-50 border border-yellow-300 rounded-md">
  <p class="text-yellow-800 font-semibold">
    ‚è≥ Purchase Order has not been created by the publisher yet.
  </p>
  <p class="text-sm text-yellow-700 mt-1">
    Please wait until the publisher issues the Purchase Order.
  </p>
</div>

<% } else { %> <% if (isRegenerated) { %>
<div class="p-4 mb-4 bg-blue-50 border border-blue-300 rounded-md">
  <p class="text-blue-800 font-semibold">
    üîÅ This Purchase Order has been regenerated by the publisher.
  </p>
  <p class="text-sm text-blue-700 mt-1">
    Please review the updated PO carefully before responding.
  </p>
</div>
<% } %>
<!-- PO CREATED -->
<p>
  <strong>PO Number:</strong>
  <%= po.poNumber || "Not generated" %>
</p>
<p><strong>Amount:</strong> ‚Çπ<%= po.amount.toLocaleString("en-IN") %></p>

<div class="mt-8 flex justify-end">
  <% if (po.pdfFile) { %>
  <a
    href="<%= po.pdfFile.fileUrl %>"
    class="px-4 py-2 rounded-lg bg-primary text-white shadow hover:bg-primary/90"
    target="_blank"
  >
    Download PDF
  </a>
  <% } %>
</div>

<hr class="my-4" />

<!-- IF vendor has NOT responded -->
<% if (["generated", "sent" ].includes(po.status)) { %>
<form method="POST" action="/user/vendor/po/<%= po._id %>/respond" class="space-y-3">
  <button name="action" value="accept" class="bg-green-600 text-white px-4 py-2 rounded-md">
    Accept PO
  </button>

  <button name="action" value="reject" class="bg-red-600 text-white px-4 py-2 rounded-md">
    Reject PO
  </button>

  <textarea
    name="reason"
    placeholder="Reason for rejection (optional)"
    class="w-full mt-3 p-3 border rounded-md"
  ></textarea>
</form>
<% } %>

<!-- IF vendor accepted -->
<% if (po.status==="vendor_accepted" ) { %>
<p class="text-green-600 font-semibold">‚úî You have accepted this Purchase Order.</p>
<% } %>

<!-- IF vendor rejected -->
<% if (po.status==="vendor_rejected" ) { %>
<p class="text-red-600 font-semibold">‚úñ You rejected this Purchase Order.</p>
<p>
  <strong>Reason:</strong>
  <%= po.rejectionReason %>
</p>
<% } %> <% } %>

<hr class="my-6 border-gray-200" />

<h2 class="text-xl font-bold mb-3">Agreement Status</h2>

<% if (agreement && agreement.uploadedByVendor) { %> <% if (agreement.approvedByPublisher===true) {
%>
<div class="p-4 bg-green-50 border border-green-300 rounded-md flex justify-between items-center">
  <div>
    <p class="text-green-800 font-semibold">‚úî Agreement Accepted by Publisher</p>
    <p class="text-sm text-green-700 mt-1">The legal agreement has been signed and finalized.</p>
  </div>
  <a
    href="/user/files/view/<%= agreement.uploadedByVendor._id %>"
    target="_blank"
    class="px-4 py-2 bg-green-600 text-white rounded-md text-sm font-bold"
  >
    View Agreement
  </a>
</div>
<% } else if (agreement.approvedByPublisher===false) { %>
<div class="p-4 bg-red-50 border border-red-300 rounded-md">
  <p class="text-red-800 font-semibold">‚úñ Agreement Rejected</p>
  <p class="text-sm text-red-700 mt-1">Publisher Remarks: <%= agreement.publisherRemarks %></p>
  <a
    href="/user/<%= tender._id %>/upload"
    class="mt-2 inline-block text-red-700 underline font-bold"
  >
    Upload New Agreement
  </a>
</div>
<% } else { %>
<div class="p-4 bg-blue-50 border border-blue-300 rounded-md flex justify-between items-center">
  <div>
    <p class="text-blue-800 font-semibold">‚è≥ Pending Publisher Approval</p>
    <p class="text-sm text-blue-700 mt-1">Your signed agreement is under review.</p>
  </div>
  <a
    href="/user/files/view/<%= agreement.uploadedByVendor._id %>"
    target="_blank"
    class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-bold"
  >
    View Uploaded DB
  </a>
</div>
<% } %> <% } else { %>
<div class="p-4 bg-gray-50 border border-gray-200 rounded-md">
  <p class="text-gray-600">Agreement not uploaded yet.</p>
  <a
    href="/user/<%= tender._id %>/upload"
    class="mt-2 inline-block text-primary underline font-bold"
  >
    Upload Agreement
  </a>
</div>
<% } %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  const params = new URLSearchParams(window.location.search);
  const response = params.get('response');
  const error = params.get('error');

  if (response === 'accept') {
    Swal.fire('PO Accepted!', 'You accepted the purchase order.', 'success');
  }

  if (response === 'reject') {
    Swal.fire('PO Rejected', 'You rejected the purchase order.', 'info');
  }

  if (error === 'po_not_created') {
    Swal.fire('PO Not Created', 'Purchase Order has not been created yet.', 'warning');
  }

  if (error === 'po_not_accepted') {
    Swal.fire('Action Required', 'Please accept the Purchase Order first.', 'info');
  }

  if (error === 'publisher_agreement_missing') {
    Swal.fire(
      'Agreement Not Available',
      'The publisher has not uploaded the agreement yet. Please wait.',
      'info'
    );
  }

  if (error === 'not_winner') {
    Swal.fire('Access Denied', 'You are not the winning vendor.', 'error');
  }

  if (error === 'server_error') {
    Swal.fire('Error', 'Something went wrong. Please try again.', 'error');
  }
</script>
