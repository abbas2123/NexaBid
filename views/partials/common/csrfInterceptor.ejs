<!-- CSRF Global Fetch Interceptor (High Priority) -->
<script>
    (function () {
        const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
        if (!csrfTokenMeta) return;

        const originalFetch = window.fetch;
        window.fetch = function (url, options = {}) {
            const method = (options.method || 'GET').toUpperCase();
            const token = csrfTokenMeta.getAttribute('content');

            if (token && ['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) {
                options.headers = options.headers || {};
                if (options.headers instanceof Headers) {
                    options.headers.set('X-CSRF-Token', token);
                } else {
                    options.headers['X-CSRF-Token'] = token;
                }
            }
            return originalFetch(url, options);
        };
    })();
</script>