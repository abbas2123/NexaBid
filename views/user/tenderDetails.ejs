<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

  <!-- TITLE -->
  <h1 class="text-3xl md:text-4xl font-bold tracking-tight text-gray-900 dark:text-white mb-8">
    <%= tender.title %>
  </h1>

  <!-- IF USER IS NOT A VERIFIED VENDOR -->
  <% if (!isVendor) { %>
    <div class="p-4 mb-8 bg-red-50 border border-red-300 text-red-800 rounded-lg">
      ðŸ”’ <strong>Access Restricted</strong><br/>
      You are not a verified vendor. You cannot participate in this tender or download files.

      <div class="mt-3">
        <a href="/vendor/apply"
           class="inline-block px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold text-sm">
          Apply for Vendor Verification
        </a>
      </div>
    </div>
  <% } %>


  <!-- WRAPPED RESTRICTED CONTENT -->
  <div class="<%= !isVendor ? 'blur-sm pointer-events-none opacity-60 select-none' : '' %>">

    <!-- OVERVIEW -->
    <section class="mb-12">
      <h2 class="text-xl font-semibold mb-4">Overview</h2>
      <p class="text-gray-600 leading-relaxed">
        <%= tender.description || "No description available." %>
      </p>
    </section>

    <!-- ELIGIBILITY -->
    <section class="mb-12">
      <h2 class="text-xl font-semibold mb-6">Eligibility Criteria</h2>

      <div class="border-t border-gray-200 pt-6 grid grid-cols-1 md:grid-cols-2 gap-8">

        <div>
          <p class="text-sm text-gray-500">Minimum Grade</p>
          <p class="text-base font-medium text-gray-900 mt-1">
            <%= tender.eligibility?.minGrade || "Not Specified" %>
          </p>
        </div>

        <div>
          <p class="text-sm text-gray-500">Required Categories</p>
          <p class="text-base font-medium text-gray-900 mt-1">
            <%= tender.eligibility?.categories?.length 
                ? tender.eligibility.categories.join(", ")
                : "Not Specified" %>
          </p>
        </div>

      </div>
    </section>

    <!-- FINANCIAL -->
    <section class="mb-12">
      <h2 class="text-xl font-semibold mb-6">Financial Details</h2>

      <div class="border-t border-gray-200 pt-6 grid grid-cols-1 md:grid-cols-2 gap-8">

        <div>
          <p class="text-sm text-gray-500">EMD Amount</p>
          <p class="text-base font-medium mt-1">
            â‚¹ <%= tender.emdAmount ? tender.emdAmount.toLocaleString("en-IN") : "N/A" %>
          </p>
        </div>

        <div>
          <p class="text-sm text-gray-500">Document Fee</p>
          <p class="text-base font-medium mt-1">
            â‚¹ <%= tender.docFee ? tender.docFee.toLocaleString("en-IN") : "N/A" %>
          </p>
        </div>

      </div>
    </section>


    <!-- DATES -->
    <section class="mb-12">

      <h2 class="text-xl font-semibold mb-6">Important Dates & Timelines</h2>

      <div class="border-t border-gray-200 pt-6 grid grid-cols-1 md:grid-cols-2 gap-8">

        <div>
          <p class="text-sm text-gray-500">Publish Date</p>
          <p class="text-base font-medium mt-1">
            <%= tender.publishAt ? new Date(tender.publishAt).toDateString() : "N/A" %>
          </p>
        </div>

        <div>
          <p class="text-sm text-gray-500">Bid Start Date</p>
          <p class="text-base font-medium mt-1">
            <%= tender.bidStartAt ? new Date(tender.bidStartAt).toDateString() : "N/A" %>
          </p>
        </div>

        <div>
          <p class="text-sm text-gray-500">Bid End Date</p>
          <p class="text-base font-medium mt-1">
            <%= tender.bidEndAt ? new Date(tender.bidEndAt).toDateString() : "N/A" %>
          </p>
        </div>

        <div>
          <p class="text-sm text-gray-500">Technical Bid Open</p>
          <p class="text-base font-medium mt-1">
            <%= tender.techOpenAt ? new Date(tender.techOpenAt).toDateString() : "N/A" %>
          </p>
        </div>

        <div>
          <p class="text-sm text-gray-500">Financial Bid Open</p>
          <p class="text-base font-medium mt-1">
            <%= tender.finOpenAt ? new Date(tender.finOpenAt).toDateString() : "N/A" %>
          </p>
        </div>

      </div>
    </section>


    <!-- FILES -->
    <section class="mb-12">
      <h2 class="text-xl font-semibold mb-6">Tender Documents</h2>

      <% if (tender.files && tender.files.length > 0) { %>

        <% tender.files.forEach(doc => { %>
          <div class="flex items-center justify-between p-4 bg-gray-50 border rounded-lg mb-3">

            <div>
              <p class="font-medium"><%= doc.fileName %></p>
              <p class="text-sm text-gray-500"><%= (doc.size/1024).toFixed(1) %> KB</p>
            </div>

            <a href="/tenders/doc/<%= doc.fileId %>"
               class="px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
              Download
            </a>

          </div>
        <% }) %>

      <% } else { %>
        <p class="text-gray-500">No documents available.</p>
      <% } %>

    </section>

  </div>


  <!-- ACTION BUTTONS -->
  <div class="flex flex-col sm:flex-row gap-4 mt-8">

    <% if (isOwner) { %>

      <!-- OWNER = cannot participate -->
      <button disabled
        class="px-6 py-3 bg-gray-300 text-gray-600 font-medium rounded-lg cursor-not-allowed opacity-60">
        You Cannot Participate (Owner)
      </button>

      <button
        class="px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 shadow"
        onclick="window.location.href='/user/status/tender-status'">
        View My Tender Status
      </button>

    <% } else if (canParticipate) { %>

      <!-- VERIFIED VENDOR = can participate -->
      <a
        href="/vendor/tender/<%= tender._id %>/bid"
        class="px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 shadow inline-block">
        Participate in Tender
      </a>

      <a
        href="/chat/start/<%= tender.issuerId || tender.createdBy?._id || tender.createdBy %>/tender/<%= tender._id %>"
        class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-gray-100 text-gray-900 font-medium rounded-lg hover:bg-gray-200 shadow">
        <span class="material-symbols-outlined">chat</span>
        Contact Department
      </a>

    <% } else { %>

      <!-- NOT VENDOR = disabled -->
      <button disabled
        class="px-6 py-3 bg-gray-300 text-gray-600 font-medium rounded-lg cursor-not-allowed opacity-60">
        Participate in Tender
      </button>

      <button disabled
        class="px-6 py-3 bg-gray-200 text-gray-500 font-medium rounded-lg cursor-not-allowed opacity-60">
        Contact Department
      </button>

    <% } %>

  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
let tenderId = "<%= tender._id %>";
let tenderOwner = "<%= tender.createdBy?._id %>"  // tender createdBy ID
let currentUser = "<%= userId.toString() %>"            // current logged-in user

async function checkTenderStatus() {
  const res = await fetch(`/tenders/status/${tenderId}`);
  const data = await res.json();

  if (!data.success) return;

  const status = data.status;

  console.log("Status Check:", status);

  // statuses where tender is no longer active
  const blockedStatuses = ["rejected", "closed", "cancelled"];

  // block only if viewer â‰  owner
  if (blockedStatuses.includes(status) && tenderOwner !== currentUser) {
    Swal.fire({
      icon: "error",
      title: "Tender Unavailable",
      text: `This tender has been ${status} by admin.`,
      confirmButtonText: "Go back"
    }).then(() => {
      window.location.href = "/tenders";
    });
  }
}

// check status every 7 seconds
setInterval(checkTenderStatus, 7000);
</script>
